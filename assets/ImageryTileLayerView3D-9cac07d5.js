import{aJ as s,aK as n,cI as F,aM as E,ai as w,cX as j,aC as L,cg as O,ge as P,gf as _}from"./index-0199b717.js";import{n as G}from"./LayerView3D-37676199.js";import{o as M}from"./TiledLayerView3D-1e45b21b.js";import{T as R,q as V}from"./rasterProjectionHelper-c683c451.js";import{d as k}from"./LayerView-a0977cc5.js";import{a as A}from"./RefreshableLayerView-8347ec95.js";import{r as J}from"./drapedUtils-bcda2fa9.js";const W=t=>{let e=class extends t{constructor(){super(...arguments),this._rasterFieldPrefix="Raster.",this.layer=null,this.view=null,this.tileInfo=null}get fullExtent(){return this._getfullExtent()}_getfullExtent(){return this.projectFullExtent(this.view.spatialReference)}get hasTilingEffects(){return!!(this.layer.renderer&&"dynamicRangeAdjustment"in this.layer.renderer&&this.layer.renderer.dynamicRangeAdjustment)}get datumTransformation(){return R(this.layer.fullExtent,this.view.spatialReference,!0)}supportsSpatialReference(i){return!!this.projectFullExtent(i)}projectFullExtent(i){const a=this.layer.fullExtent,r=R(a,i,!1);return V(a,i,r)}async fetchPopupFeatures(i,a){const{layer:r}=this;if(!i)throw new w("imageryTileLayerView:fetchPopupFeatures","Nothing to fetch without area",{layer:r});const{popupEnabled:m}=r,y=j(r,a);if(!m||y==null)throw new w("imageryTileLayerView:fetchPopupFeatures","Missing required popupTemplate or popupEnabled",{popupEnabled:m,popupTemplate:y});const p=[],{value:l,magdirValue:o,processedValue:S}=await r.identify(i,{timeExtent:this.timeExtent});let c="";if(l&&l.length){c=r.type==="imagery-tile"&&r.hasStandardTime()&&l[0]!=null?l.map(b=>r.getStandardTimeValue(b)).join(", "):l.join(", ");const d={ObjectId:0},v="Raster.ServicePixelValue";d[v]=S?.join(", ")??c,d[v+".Raw"]=c;const T=r.rasterInfo.attributeTable;if(T!=null){const{fields:b,features:z}=T,I=b.find(({name:u})=>u.toLowerCase()==="value"),g=I?z.find(u=>String(u.attributes[I.name])===c):null;if(g)for(const u in g.attributes)g.attributes.hasOwnProperty(u)&&(d[this._rasterFieldPrefix+u]=g.attributes[u])}const x=r.rasterInfo.dataType;x!=="vector-magdir"&&x!=="vector-uv"||(d["Raster.Magnitude"]=o?.[0],d["Raster.Direction"]=o?.[1]);const f=new L(this.fullExtent.clone(),null,d);f.layer=r,f.sourceLayer=f.layer,p.push(f)}return p}};return s([n()],e.prototype,"layer",void 0),s([n(F)],e.prototype,"timeExtent",void 0),s([n()],e.prototype,"view",void 0),s([n()],e.prototype,"fullExtent",null),s([n()],e.prototype,"tileInfo",void 0),s([n({readOnly:!0})],e.prototype,"hasTilingEffects",null),s([n()],e.prototype,"datumTransformation",null),e=s([E("esri.views.layers.ImageryTileLayerView")],e),e};let h=class extends W(A(M(G(k)))){constructor(){super(...arguments),this.type="imagery-tile-3d",this.isAlignedMapTile=!0}initialize(){this.layer.increaseRasterJobHandlerUsage(),this.fullExtent==null&&this.addResolvingPromise(Promise.reject(new w("layerview:spatial-reference-incompatible","The layer extent cannot be projected to the view's spatial reference",{layer:this.layer})));const t=O(()=>this.view?.basemapTerrain?.tilingSchemeLocked).then(()=>{const e=this.view.basemapTerrain.tilingScheme,i=this.layer.tileInfo,a=["png","png24","png32","jpg","mixed"].includes(i.format)&&e.compatibleWith(i);this.isAlignedMapTile=a;const r=a?i:e.toTileInfo();this.tileInfo=r,this.updatingHandles.add(()=>[this.layer.renderer,this.layer.interpolation,this.layer.bandIds,this.layer.multidimensionalDefinition,this.layer.multidimensionalSubset,this.layer.rasterFunction,this.timeExtent],()=>this.refresh())});this.addResolvingPromise(t)}destroy(){this.layer.decreaseRasterJobHandlerUsage(),this.view=null}get _blankTile(){const t=document.createElement("canvas"),e=t.getContext("2d"),[i,a]=this.tileInfo.size;return t.width=i,t.height=a,e.clearRect(0,0,i,a),e.getImageData(0,0,i,a)}get imageFormatIsOpaque(){return this.layer.tileInfo.format==="jpg"}get hasMixedImageFormats(){return this.layer.tileInfo.format==="mixed"}get dataLevelRange(){const t=this.tileInfo.lods,e=this.layer.tileInfo.lods,i=t[0].scale,a=e[e.length-1].scale;return this.levelRangeFromScaleRange(i,a)}_getfullExtent(){return this.projectFullExtent(this.view.basemapTerrain&&this.view.basemapTerrain.spatialReference!=null?this.view.basemapTerrain.spatialReference:this.view.spatialReference)}async fetchTile(t,e,i,a){const r=this.tileInfo,m=this._canSymbolizeInWebGL(),y={tileInfo:r,requestRawData:m,signal:a.signal,timeExtent:this.timeExtent,requestAsImageElement:this.isAlignedMapTile},p=await this.layer.fetchTile(t,e,i,y);if(p instanceof HTMLImageElement)return p;let l=p&&p.pixelBlock;if(l==null)return this._blankTile;if(!m&&(l=await this.layer.applyRenderer(p),l==null))return this._blankTile;const o=new P([t,e,i],l,r.size[0],r.size[1]);return m?(o.symbolizerRenderer=this.layer.symbolizer.rendererJSON,o.symbolizerParameters=this.layer.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(t)),o.transformGrid=p.transformGrid):o.isRendereredSource=!0,o.interpolation=this.layer.interpolation,o.bandIds=this.layer.bandIds,o}_getSymbolizerOptions(t){const e=this.tileInfo.lodAt(t).resolution;return{pixelBlock:null,isGCS:this.view.basemapTerrain&&this.view.basemapTerrain.spatialReference!=null?this.view.basemapTerrain.spatialReference.isGeographic:this.view.spatialReference.isGeographic,resolution:{x:e,y:e},bandIds:this.layer.bandIds}}ensureSymbolizerParameters(t){this._canSymbolizeInWebGL()&&JSON.stringify(t.symbolizerRenderer)!==JSON.stringify(this.layer.symbolizer.rendererJSON)&&(t.symbolizerParameters=this.layer.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(t.lij[0])))}createFetchPopupFeaturesQueryGeometry(t,e){return J(t,e,this.view)}refresh(){this.emit("data-changed")}async doRefresh(){this.suspended||this.emit("data-changed")}_canSymbolizeInWebGL(){return _("3d").supportsTextureFloat&&this.layer.symbolizer.canRenderInWebGL}};s([n({readOnly:!0})],h.prototype,"_blankTile",null),s([n({readOnly:!0})],h.prototype,"imageFormatIsOpaque",null),s([n({readOnly:!0})],h.prototype,"hasMixedImageFormats",null),s([n({readOnly:!0})],h.prototype,"dataLevelRange",null),h=s([E("esri.views.3d.layers.ImageryTileLayerView3D")],h);const U=h;export{U as default};
