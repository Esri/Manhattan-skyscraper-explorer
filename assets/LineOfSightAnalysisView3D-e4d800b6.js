import{aJ as n,aK as o,bH as u,aM as I,aP as P,bx as y,ax as Y,gJ as ge,jo as je,qe as Be,bm as Ue,qf as qe,lt as Me,lz as We,hK as ae,lu as Je,lw as Ke,lx as Ze,qg as Qe,hx as J,qh as le,qi as Xe,qj as re,qk as Ye,f2 as T,d3 as ve,lp as B,gB as U,ow as ye,ae as _e,cm as De,aF as be,ql as fe,aG as K,d9 as ee,gA as et,qm as tt,qn as it,ji as X,qo as j,by as nt,qp as Ce,bb as te,cK as ie,aH as H,b4 as we,b3 as ot,mm as st,b7 as ke,cG as rt,oH as at,pT as Oe,qq as lt,pK as Z,q9 as ut,gF as dt,aZ as ct,b2 as pt,aI as M,fh as ze,gG as ht,qr as ue,qs as Te,g1 as Ie,jf as de,ix as k,f4 as gt,aA as vt}from"./index-9e6e60fd.js";import{a as Pe,i as xe,u as yt,f as _t,c as ce,e as mt}from"./LineVisualElement-50cc6889.js";import{l as pe,u as Ve,f as Le}from"./LineOfSightAnalysisTarget-5a53444b.js";import{g as Se,s as bt,c as ft}from"./elevationInfoUtils-2ae63ad5.js";import{$ as Ct,e as wt,F as Ot,a as Tt,d as Re,b as It,v as Pt}from"./analysisViewUtils-5c278670.js";import{c as Vt,y as Ee}from"./PointVisualElement-4d9a6ae3.js";import"./ImageMaterial-e61aaffd.js";import"./VisualElementResources-b8a49c00.js";let R=class extends P{constructor(t){super(t),this.innerWidth=2,this.outerWidth=8,this.visibleInnerColor=new u([3,252,111,1]),this.visibleOuterColor=new u([3,252,111,.15]),this.occludedInnerColor=new u([252,3,69,1]),this.occludedOuterColor=new u([252,3,69,.1]),this.undefinedInnerColor=new u([255,255,255,1]),this.undefinedOuterColor=new u([127,127,127,.2])}};n([o({type:Number})],R.prototype,"innerWidth",void 0),n([o({type:Number})],R.prototype,"outerWidth",void 0),n([o({type:u})],R.prototype,"visibleInnerColor",void 0),n([o({type:u})],R.prototype,"visibleOuterColor",void 0),n([o({type:u})],R.prototype,"occludedInnerColor",void 0),n([o({type:u})],R.prototype,"occludedOuterColor",void 0),n([o({type:u})],R.prototype,"undefinedInnerColor",void 0),n([o({type:u})],R.prototype,"undefinedOuterColor",void 0),R=n([I("esri.views.3d.analysis.LineOfSight.LineOfSightConfiguration")],R);let z=class extends P{constructor(e){super(e),this.target=null,this.intersectedGraphic=null,this.intersectedLocation=null,this.elevationAlignedTargetLocation=null,this.visible=void 0}};n([o()],z.prototype,"target",void 0),n([o()],z.prototype,"intersectedGraphic",void 0),n([o()],z.prototype,"intersectedLocation",void 0),n([o()],z.prototype,"elevationAlignedTargetLocation",void 0),n([o({type:Boolean})],z.prototype,"visible",void 0),z=n([I("esri.views.3d.analysis.LineOfSightAnalysisResult")],z);let x=class extends P{constructor(e){super(e),this.elevationAlignedTargetLocation=null,this.inputPoints={isValid:!1,observer:y(),observerSurfaceNormal:null,observerFeatureId:null,target:y(),targetSurfaceNormal:null,targetFeatureId:null,observerAdjusted:y(),targetAdjusted:y()},this.computationResult={start:y(),end:y(),intersection:y(),isValid:!1,isTargetVisible:!1},this.result=null}notifyResultChanged(){this.notifyChange("computationResult")}notifyInputPointsChanged(){this.notifyChange("inputPoints")}};n([o()],x.prototype,"target",void 0),n([o()],x.prototype,"elevationAlignedTargetLocation",void 0),n([o()],x.prototype,"inputPoints",void 0),n([o()],x.prototype,"computationResult",void 0),n([o()],x.prototype,"result",void 0),x=n([I("esri.views.3d.analysis.LineOfSight.LineOfSightComputation")],x);var me;let L=me=class extends P{constructor(e){super(e)}clone(){return new me({type:this.type,id:Y(this.id),mapPoint:Y(this.mapPoint),renderPoint:ge(this.renderPoint),normal:Y(this.normal),ray:Y(this.ray),graphic:this.graphic})}equals(e){return this.type===e.type&&this.id===e.id&&je(this.mapPoint,e.mapPoint)&&Be(this.renderPoint,e.renderPoint)&&Ue(this.normal,e.normal)&&qe(this.ray,e.ray)&&this.graphic===e.graphic}};n([o()],L.prototype,"type",void 0),n([o({constructOnly:!0})],L.prototype,"id",void 0),n([o({constructOnly:!0})],L.prototype,"mapPoint",void 0),n([o({constructOnly:!0})],L.prototype,"renderPoint",void 0),n([o({constructOnly:!0})],L.prototype,"normal",void 0),n([o({constructOnly:!0})],L.prototype,"graphic",void 0),n([o({constructOnly:!0})],L.prototype,"ray",void 0),L=me=n([I("esri.views.3d.analysis.LineOfSight.LineOfSightIntersectionResult")],L);let q=class extends P{constructor(e){super(e),this._terrainIntersectionOptionsLayerUids=new Set(["terrain"])}initialize(){this.intersector=We(this.view.state.viewingMode),this.intersector.options.hud=!1,this.intersector.options.store=ae.MIN}getScreenPointIntersection(e){const t=Je(e,Ke.get()),i=Ze(this.view.state.camera,t,he);return this._getRayIntersection(i)}_getRayIntersection(e,t){if(e==null||this.view.sceneIntersectionHelper==null)return null;this.intersector.options.store=ae.MIN,this.view.sceneIntersectionHelper.intersectToolIntersectorRay(e,this.intersector,t);const i=this.intersector.results.min,s=y();if(!i.getIntersectionPoint(s))return null;const r=this.view.renderCoordsHelper.fromRenderCoords(s,this.view.spatialReference),l=ge(i.normal);if(Qe(i))return new L({type:J.OBJECT,id:`${i.target.layerUid}/${i.target.nodeIndex}/${i.target.componentIndex}`,mapPoint:r,renderPoint:s,normal:l,ray:le(e),graphic:null});if(Xe(i))return new L({type:J.TERRAIN,id:i.target.lij.slice(),mapPoint:r,renderPoint:s,normal:l,ray:le(e),graphic:null});const a=re(i,this.view);if(a!=null){const h=a.layer,p=a.sourceLayer;let c;return p&&p.type==="scene"?c=Ye(a,p.objectIdField):c=a.uid,new L({type:J.OBJECT,id:`${h?.uid}/${c}`,mapPoint:r,renderPoint:s,normal:l,ray:le(e),graphic:a})}return null}updateFromGroundIntersection(e,t,i){const s=Lt,r=St,l=Rt,a=Et;T(r,e),this.view.renderCoordsHelper.worldUpAtPosition(r,l),ve(l,l);const h=this.view.basemapTerrain.visibleElevationBounds,p=h?Math.abs(h.max-h.min):100,c=t>=0?1:-1;B(a,l,c*(p+Math.abs(t))),U(s,r,a),ye(s,r,he);const d=this._getRayIntersection(he,{include:this._terrainIntersectionOptionsLayerUids});return d!=null?(B(a,l,c*t),U(i,d.renderPoint,a),ge(d.normal)):(T(i,e),null)}};n([o()],q.prototype,"view",void 0),n([o()],q.prototype,"intersector",void 0),q=n([I("esri.views.3d.analysis.LineOfSight.LineOfSightRayIntersector")],q);const Lt=y(),St=y(),Rt=y(),Et=y(),he=Me(),Fe="esri.views.3d.analysis.LineOfSight.LineOfSightController",Ae=_e.getLogger(Fe);let m=class extends De.EventedMixin(P){constructor(e){super(e),this.updateOnCameraChange=!0,this._observerGroundOffsetRenderSpace=0,this._effectiveObserverElevationMode="absolute-height",this._observerFeatureId=null,this._updatingHandles=new be,this._frameTask=fe,this._handles=new K,this._computationHandles=new K,this._externalObserverUpdate=!0}initialize(){const e=this.view.resourceController?.scheduler;this._frameTask=e?e.registerTask(ee.LINE_OF_SIGHT_TOOL):fe,this._intersector=new q({view:this.view}),this._handles.add([this._connectObserver(),this._connectComputations(),this._connectTargets()])}destroy(){this._handles.destroy(),this._computationHandles.destroy(),this._computations.removeAll(),this._updatingHandles.destroy()}get updating(){return this._frameTask.updating||this._updatingHandles.updating}get priority(){return this._frameTask.priority}set priority(e){this._frameTask.priority=e}get _computations(){return this.analysisViewData.computations}get _elevationAlignedObserverPositionRenderSpace(){return this.analysisViewData.observerEngineLocation}set _elevationAlignedObserverPositionRenderSpace(e){this.analysisViewData.observerEngineLocation=e}get _screenPixelSize(){return this.view.state.camera.computeScreenPixelSizeAt(this._elevationAlignedObserverPositionRenderSpace)}_computeResult(e){const t=e.computation,{inputPoints:i,computationResult:s}=t,{observerAdjusted:r,targetAdjusted:l}=i,{start:a,end:h}=s;T(a,r),T(h,l),this._canCompute(t)?this._computeIntersection(e):this._interpolateIntersection(e),t.notifyResultChanged(),this.emit("result-changed",{target:e.computation.target,result:t.result})}_updateAdjustedPointsFromFeatures(e){const t=this.view,{sceneIntersectionHelper:i}=t,{inputPoints:s}=e,{observerAdjusted:r,observerFeatureId:l,targetFeatureId:a,targetAdjusted:h}=s;if(l==null&&a==null)return;const p=et(r,h),c=this._intersector.intersector,d=ye(s.observer,s.target,$e);c.options.store=ae.ALL,i.intersectToolIntersectorRay(d,c);let v=null,g=null,f=null,O=null;for(const w of c.results.all){const _=re(w,this.view);if(_==null||w.distanceInRenderSpace==null)continue;const S=pe(_);S!=null&&(l!=null&&S===l&&(v==null&&(v=this._getFeatureDistanceThreshold(w,t,p)),w.distanceInRenderSpace<v&&(f=w)),a!=null&&S===a&&(g==null&&(g=this._getFeatureDistanceThreshold(w,t,p)),O==null&&w.distanceInRenderSpace<p&&p-w.distanceInRenderSpace<g&&(O=w)))}f!=null&&f.getIntersectionPoint(r)&&(s.observerSurfaceNormal=f.getTransformedNormal(y())),O!=null&&O.getIntersectionPoint(h)&&(s.targetSurfaceNormal=O.getTransformedNormal(y()))}_getFeatureDistanceThreshold(e,t,i){if(tt(e)){const s=it(e,t);if(s!=null)return Math.min(s*$t,i)}return 1e-5*i}_adjustStartEndPositions(e){const t=this._screenPixelSize,i=this.view,{inputPoints:s}=e,{observer:r,observerSurfaceNormal:l,target:a,targetSurfaceNormal:h,observerAdjusted:p,targetAdjusted:c}=s,d=ne;T(p,r),T(c,a),this._updateAdjustedPointsFromFeatures(e),l!=null?T(d,l):X(d,c,p);const v=t;ve(d,d),B(d,d,Math.min(v,1)),U(p,p,d),h!=null?T(d,h):X(d,p,c);const g=i.state.camera.computeScreenPixelSizeAt(c);ve(d,d),B(d,d,Math.min(g,1)),U(c,c,d)}_computeIntersection({computation:e,interpolationInfo:t}){const{view:i}=this,{sceneIntersectionHelper:s,renderCoordsHelper:r}=i;if(s==null)return;const l=this._intersector.intersector,{computationResult:a,inputPoints:h}=e,{observer:p,target:c}=h,{start:d,end:v}=a,g=ye(d,v,$e);l.options.store=ae.MIN,s.intersectToolIntersectorRay(g,l);const f=l.results.min,O=a.intersection,w=ne;let _=!0;if(f!=null&&f.getIntersectionPoint(O)){T(t.originalIntersection,O),T(t.originalObserver,d),T(t.originalTarget,v),r.fromRenderCoords(O,w,i.spatialReference);const V=1-j(v,c)/j(d,c);_=j(p,O)>=V*j(p,c)}const S=new nt(w,i.spatialReference);{const{result:V,target:D}=e;V!=null?(V.target=D,V.intersectedGraphic=_?null:re(f,i),V.intersectedLocation=_?null:S,V.visible=_):e.result=new z({target:D,elevationAlignedTargetLocation:e.elevationAlignedTargetLocation,intersectedGraphic:_?null:re(f,i),intersectedLocation:_?null:S,visible:_})}a.isValid=h.isValid=!0,a.isTargetVisible=_}_interpolateIntersection({computation:e,interpolationInfo:t}){const{computationResult:i,inputPoints:s}=e,{start:r,end:l,intersection:a}=i,{originalIntersection:h,originalObserver:p,originalTarget:c}=t;if(T(a,h),s.isValid){const d=ne,v=j(p,h)/j(p,c);Ce(d,r,p),B(d,d,1-v),U(a,a,d),Ce(d,l,c),B(d,d,v),U(a,a,d),i.isValid=!0}else e.result=null,i.isValid=!1,i.isTargetVisible=!1}_canCompute(e){const t=this.analysisViewData.elevationAlignedObserver,i=this.view.frustum;if(t==null||e.elevationAlignedTargetLocation==null||i==null)return!1;const{observerAdjusted:s,targetAdjusted:r}=e.inputPoints,l=i.intersectsPoint(s),a=i.intersectsPoint(r);return l&&a}_onObserverPositionChange(e,t,i,s,r){if(this._externalObserverUpdate=r,e==null)return this.analysisViewData.elevationAlignedObserver=null,void(this._observerFeatureId=null);if(t==null)return Pe(this.analysis,e.spatialReference,Ae),void(this.analysisViewData.elevationAlignedObserver=null);const l=this._getEffectiveElevationInfo(t,i),{absoluteZ:a,elevation:h}=Se(t.x,t.y,t.z,this.view.spatialReference,this.view,l),p=t.clone();p.z=a,this._effectiveObserverElevationMode=l.mode,this.analysisViewData.elevationAlignedObserver=p;const c=y();this.view.renderCoordsHelper.toRenderCoords(p,c),this._elevationAlignedObserverPositionRenderSpace=c,this._observerGroundOffsetRenderSpace=a-h,this._observerFeatureId=pe(s),this.priority=ee.LINE_OF_SIGHT_TOOL_INTERACTIVE}_onObserverRenderSpacePositionChangeForComputation(e,t,i,s,r){const{inputPoints:l}=e;switch(T(l.observer,t),l.observerFeatureId=r,l.observerSurfaceNormal=null,s){case"on-the-ground":case"relative-to-ground":{const a=this._intersector.updateFromGroundIntersection(l.observer,i,l.observer);l.observerFeatureId==null&&(l.observerSurfaceNormal=a)}}this._adjustStartEndPositions(e),e.notifyInputPointsChanged(),this.priority=ee.LINE_OF_SIGHT_TOOL_INTERACTIVE}_onTargetPositionChange(e,t,i,s,r,l=!0){const a=e.inputPoints;if(l&&(a.isValid=!1),i==null)return t!=null&&Pe(this.analysis,t.spatialReference,Ae),e.elevationAlignedTargetLocation=null,void e.notifyInputPointsChanged();const h=this._getEffectiveElevationInfo(i,s),{absoluteZ:p,elevation:c}=Se(i.x,i.y,i.z,this.view.spatialReference,this.view,h),d=i.clone();switch(d.z=p,e.elevationAlignedTargetLocation=d,this.view.renderCoordsHelper.toRenderCoords(e.elevationAlignedTargetLocation,a.target),a.targetFeatureId=pe(r),a.targetSurfaceNormal=null,h.mode){case"on-the-ground":case"relative-to-ground":{const v=this._intersector.updateFromGroundIntersection(a.target,p-c,a.target);a.targetFeatureId==null&&(a.targetSurfaceNormal=v)}}this._adjustStartEndPositions(e),e.notifyInputPointsChanged(),this.priority=ee.LINE_OF_SIGHT_TOOL_INTERACTIVE}_connectComputationToTarget(e){return te([this._updatingHandles.add(()=>({computation:e,targetPosition:e.target.position,targetElevationInfo:e.target.elevationInfo,targetFeatureInfo:e.target.feature,projectedTargetPosition:ie(e.target.position,this.view.spatialReference)}),({computation:t,targetPosition:i,targetElevationInfo:s,targetFeatureInfo:r,projectedTargetPosition:l})=>{l.pending==null?this._onTargetPositionChange(t,i,l.geometry,s,r):this._updatingHandles.addPromise(l.pending)},H)])}_connectComputationToObserver(e){return this._updatingHandles.add(()=>({computation:e,observer:this.analysisViewData.elevationAlignedObserver}),({computation:t})=>{this._externalObserverUpdate&&(t.inputPoints.isValid=!1,t.notifyInputPointsChanged())},H)}_connectComputationToRenderSpaceObserver(e){return this._updatingHandles.add(()=>({computation:e,observer:this._elevationAlignedObserverPositionRenderSpace,observerGroundOffset:this._observerGroundOffsetRenderSpace,observerElevationMode:this._effectiveObserverElevationMode,observerFeatureId:this._observerFeatureId}),({computation:t,observer:i,observerGroundOffset:s,observerElevationMode:r,observerFeatureId:l})=>{this._onObserverRenderSpacePositionChangeForComputation(t,i,s,r,l)},H)}_connectComputationToCamera(e){return this._updatingHandles.add(()=>({camera:this.view.state.camera,isDirty:this._isCameraDirty}),({isDirty:t})=>{!this.updateOnCameraChange||e.inputPoints.isValid&&!t||e.notifyInputPointsChanged()})}_connectComputationToSlicePlane(e){return this._updatingHandles.add(()=>this.view.slicePlane,()=>{e.inputPoints.isValid=!1,e.notifyInputPointsChanged()})}_connectComputationToElevation(e){const t=(i,s)=>{const r=this.analysis.observer,l=e.target;let a=null,h=null,p=null,c=null,d=null,v=null;if(r!=null&&r.position!=null){const g=ie(r.position,this.view.spatialReference);if(g.pending!=null)return this._updatingHandles.addPromise(g.pending),void g.pending.finally(()=>t(i,s));a=g.geometry,h=r.elevationInfo,p=r.feature}if(l.position!=null){const g=ie(l.position,this.view.spatialReference);if(g.pending!=null)return this._updatingHandles.addPromise(g.pending),void g.pending.finally(()=>t(i,s));c=g.geometry,d=l.elevationInfo,v=l.feature}a==null&&c==null||(at(i,s,oe,this.view.spatialReference),a!=null&&Oe(oe,a)&&this._onObserverPositionChange(r!=null?r.position:null,a,h,p,!1),c!=null&&Oe(oe,c)&&this._onTargetPositionChange(e,l.position,c,d,v,!1),a!=null&&c!=null&&lt(oe,a,c)&&e.notifyInputPointsChanged())};return this.view.elevationProvider.on("elevation-change",i=>t(i.extent,i.spatialReference))}_connectComputationToTask(e){let t=null;const i={computation:e,interpolationInfo:{originalIntersection:y(),originalObserver:y(),originalTarget:y()}};return te([this._updatingHandles.add(()=>e.inputPoints,()=>{t=we(t),t=ot(async s=>{await st(this._frameTask.schedule(()=>this._computeResult(i),s))})},{initial:!0,equals:()=>!1}),ke(()=>t=we(t))])}_connectComputation(e){const t=this._computationHandles;t.has(e)||t.add([this._connectComputationToTarget(e),this._connectComputationToObserver(e),this._connectComputationToRenderSpaceObserver(e),this._connectComputationToCamera(e),this._connectComputationToSlicePlane(e),this._connectComputationToElevation(e),this._connectComputationToTask(e)],e)}_disconnectComputation(e){this._computationHandles.remove(e)}_onComputationCollectionChange({added:e,removed:t}){for(const i of t)this._disconnectComputation(i);for(const i of e)this._connectComputation(i)}_onTargetCollectionChange({added:e,removed:t}){for(const i of t)this._removeTarget(i);for(const i of e)this._addTarget(i)}_onCursorTargetChange(e,t){t!=null&&this._removeTarget(t),e!=null&&this._addTarget(e)}_addTarget(e){this._computations.some(t=>t.target===e)||this._computations.add(new x({target:e}))}_removeTarget(e){const t=this._computations.findIndex(i=>i.target===e);this._computations.removeAt(t)}_connectObserver(){return te([this._updatingHandles.add(()=>({observerPosition:this.analysis.observer!=null?this.analysis.observer.position:null,projectedObserverPosition:ie(this.analysis.observer!=null?this.analysis.observer.position:null,this.view.spatialReference),observerElevationInfo:this.analysis.observer!=null?this.analysis.observer.elevationInfo:null,observerFeatureInfo:this.analysis.observer!=null?this.analysis.observer.feature:null}),({observerPosition:e,projectedObserverPosition:t,observerElevationInfo:i,observerFeatureInfo:s})=>{t.pending==null?this._onObserverPositionChange(e,t.geometry,i,s,!0):this._updatingHandles.addPromise(t.pending)},H)])}_connectComputations(){return this._updatingHandles.addOnCollectionChange(()=>this._computations,e=>this._onComputationCollectionChange(e),{initial:!0,final:!0})}_connectTargets(){return te([this._updatingHandles.addOnCollectionChange(()=>this.analysis.targets,e=>this._onTargetCollectionChange(e),{initial:!0,final:!0}),this._updatingHandles.add(()=>this.analysisViewData.cursorTarget,(e,t)=>{this._onCursorTargetChange(e,t)})])}get _isCameraDirty(){const e=this.analysisViewData.elevationAlignedObserver,{view:t}=this,{renderCoordsHelper:i}=t;if(e==null||i==null)return!1;const s=ne;i.toRenderCoords(e,s);const r=t.state.camera.computeScreenPixelSizeAt(s);return Math.abs((r-this._screenPixelSize)/this._screenPixelSize)>At}_getEffectiveElevationInfo(e,t){return e.hasZ?t??{mode:"absolute-height",offset:0}:{mode:"on-the-ground",offset:0}}};n([o({constructOnly:!0})],m.prototype,"analysis",void 0),n([o({constructOnly:!0})],m.prototype,"analysisViewData",void 0),n([o({constructOnly:!0})],m.prototype,"view",void 0),n([o()],m.prototype,"updating",null),n([o()],m.prototype,"priority",null),n([o()],m.prototype,"updateOnCameraChange",void 0),n([o()],m.prototype,"_computations",null),n([o()],m.prototype,"_elevationAlignedObserverPositionRenderSpace",null),n([o()],m.prototype,"_observerGroundOffsetRenderSpace",void 0),n([o()],m.prototype,"_effectiveObserverElevationMode",void 0),n([o()],m.prototype,"_observerFeatureId",void 0),n([o()],m.prototype,"_screenPixelSize",null),n([o({readOnly:!0})],m.prototype,"_updatingHandles",void 0),n([o()],m.prototype,"_frameTask",void 0),n([o()],m.prototype,"_isCameraDirty",null),m=n([I(Fe)],m);const At=.1,ne=y(),$e=Me(),oe=rt(),$t=.05;let A=class extends P{constructor(e){super(e),this.enabled=!0,this.glowColor=xe(),this.glowWidth=8,this.innerColor=yt(),this.innerWidth=.75,this.globalAlpha=_t(.75)}};n([o({type:Boolean})],A.prototype,"enabled",void 0),n([o({type:u})],A.prototype,"glowColor",void 0),n([o({type:Number})],A.prototype,"glowWidth",void 0),n([o({type:u})],A.prototype,"innerColor",void 0),n([o({type:Number})],A.prototype,"innerWidth",void 0),n([o({type:Number})],A.prototype,"globalAlpha",void 0),A=n([I("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightLaserLineConfiguration")],A);let W=class extends P{constructor(e){super(e),this.size=.5,this.color=xe(.75)}};n([o({type:Number})],W.prototype,"size",void 0),n([o({type:u})],W.prototype,"color",void 0),W=n([I("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightObserverConfiguration")],W);let F=class extends P{constructor(t){super(t),this.size=.5,this.visibleColor=new u([3,252,111,.75]),this.occludedColor=new u([252,3,69,.75]),this.undefinedColor=new u([127,127,127,.75])}};n([o({type:Number})],F.prototype,"size",void 0),n([o({type:u})],F.prototype,"visibleColor",void 0),n([o({type:u})],F.prototype,"occludedColor",void 0),n([o({type:u})],F.prototype,"undefinedColor",void 0),F=n([I("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightTargetConfiguration")],F);let $=class extends P{constructor(t){super(t),this.innerWidth=2,this.outerWidth=8,this.visibleInnerColor=new u([3,252,111,1]),this.visibleOuterColor=new u([3,252,111,.15]),this.occludedInnerColor=new u([252,3,69,1]),this.occludedOuterColor=new u([252,3,69,.1]),this.undefinedInnerColor=new u([255,255,255,1]),this.undefinedOuterColor=new u([127,127,127,.2])}};n([o({type:Number})],$.prototype,"innerWidth",void 0),n([o({type:Number})],$.prototype,"outerWidth",void 0),n([o({type:u})],$.prototype,"visibleInnerColor",void 0),n([o({type:u})],$.prototype,"visibleOuterColor",void 0),n([o({type:u})],$.prototype,"occludedInnerColor",void 0),n([o({type:u})],$.prototype,"occludedOuterColor",void 0),n([o({type:u})],$.prototype,"undefinedInnerColor",void 0),n([o({type:u})],$.prototype,"undefinedOuterColor",void 0);let G=class extends P{constructor(e){super(e),this.laserLine=new A,this.observer=new W,this.target=new F,this.lineOfSight=new $}};n([o({type:A})],G.prototype,"laserLine",void 0),n([o({type:W})],G.prototype,"observer",void 0),n([o({type:F})],G.prototype,"target",void 0),n([o({type:$})],G.prototype,"lineOfSight",void 0),G=n([I("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightToolConfiguration")],G);function Ht(e,t){let i=null;const s=e.events.on("grab-changed",r=>{i!=null&&(i.remove(),i=null),r.action==="start"&&(i=e.disableDisplay()),t&&t(r)});return{remove(){i?.remove(),s.remove()}}}function se(e,t,i){return new wt(ut(Ot(u.toUnitRGBA(t)),e,32,32),i)}function Ge(e){const t=[];return e.customColor1&&t.push(se(e.size,e.customColor1,Z.Custom1)),e.customColor2&&t.push(se(e.size,e.customColor2,Z.Custom2)),e.customColor3&&t.push(se(e.size,e.customColor3,Z.Custom3)),e.color&&t.push(se(e.size,e.color)),t}function Mt(e,t){const i=Ge(t),s=new Ct({view:e,renderObjects:i,elevationInfo:{mode:"absolute-height",offset:0}});return Ht(s),s}var N;(function(e){e.Ready="ready",e.Creating="creating",e.Created="created"})(N||(N={}));let C=class extends Tt{constructor(e){super(e),this.removeIncompleteOnCancel=!1,this.configuration=new G,this.analysisViewData=null,this._latestPointerMovePointerType=null,this._laserlineVisualElement=null,this._grabbedManipulator=null,this._analysisHandles=new K,this._handles=new K,this._updatingHandles=new be,this._manipulatorHandles=new K,this._targetTrackerManipulator=null}initialize(){this._intersector=new q({view:this.view}),this._handles.add(ct(()=>this.state,e=>{e===N.Created&&this.finishToolCreation()},pt)),this._observerManipulator=this._createObserverManipulator(),this._handles.add([this._updatingHandles.add(()=>({...this.configuration.observer}),()=>this._updateObserverManipulatorStyle()),this._updatingHandles.add(()=>this.analysisViewData?.elevationAlignedObserver,e=>this._onObserverLocationChange(e),H),this._updatingHandles.add(()=>({...this.configuration.laserLine}),()=>this._createVisualElements(),H),this._updatingHandles.add(()=>this._laserLineRendererDependencies(),e=>this._updateLaserLineRenderer(e)),this._connectComputations(),this._updatingHandles.addWhen(()=>!this._shouldRenderTracker,()=>this._clearCursorTracker(),H)])}destroy(){this._updatingHandles=M(this._updatingHandles),this._handles=M(this._handles),this._manipulatorHandles=M(this._manipulatorHandles),this._analysisHandles=M(this._analysisHandles),this._observerManipulator=null,this._clearCursorTracker(),this._removeVisualElements(),this._intersector=null,this._set("analysis",null)}get state(){return this.active?this.hasGrabbedManipulators?N.Created:N.Creating:this.analysis.observer!=null&&this.analysis.observer.position!=null?N.Created:N.Ready}get cursor(){return this.active&&this._showTracker?"crosshair":null}get updating(){return this.analysisViewData!=null&&this.analysisViewData.updating||this._updatingHandles.updating}get _showTracker(){return this.active&&this._latestPointerMovePointerType==="mouse"}get _shouldRenderTracker(){return this._showTracker&&this.analysis.observer!=null&&this.analysis.observer.position!=null&&!this.hasGrabbedManipulators}continue(){this.view.activeTool=this}stop(){this.view.activeTool=null}onEditableChange(){this.analysisViewData.editable=this.internallyEditable}onInputEvent(e){switch(e.type){case"immediate-double-click":this._doubleClickHandler(e);break;case"key-down":this._keyDownHandler(e);break;case"pointer-move":this._pointerMoveHandler(e)}}onInputEventAfter(e){e.type==="immediate-click"&&this._clickHandler(e)}onShow(){}onHide(){}onDeactivate(){this._clearCursorTracker()}_connectComputations(){return this._updatingHandles.addOnCollectionChange(()=>this.analysisViewData.computations,e=>this._onComputationsCollectionChange(e),{initial:!0,final:!0})}_onComputationsCollectionChange({added:e,removed:t}){for(const i of t)this._disconnectComputation(i);for(const i of e)this._connectComputation(i)}_connectComputation(e){if(this.destroyed)return void _e.getLogger(this).warn("Attempting to connect an analysis to a destroyed LineOfSight tool. Ignoring.");const t=this._analysisHandles;if(t.has(e))return;const i=this._createTargetManipulator(e.target);this._targetTrackerManipulator==null&&i.metadata.target===this.analysisViewData.cursorTarget&&(this._targetTrackerManipulator=i,this._targetTrackerManipulator.available=!1,this._targetTrackerManipulator.interactive=!1,this._updateLaserLineRenderer()),t.add([this._updatingHandles.add(()=>this._getLineOfSightManipulatorStateDependencies(e),()=>this._updateManipulatorState(i,e),H),this._updatingHandles.add(()=>e.elevationAlignedTargetLocation,s=>this._onTargetLocationChange(s,i),H)],e)}_disconnectComputation(e){if(this.destroyed)return void _e.getLogger(this).warn("Attempting to disconnect an analysis from a destroyed LineOfSight tool. Ignoring.");this._analysisHandles.remove(e);const t=this._getTargetManipulator(e.target);t!=null&&(this.manipulators.remove(t),this._manipulatorHandles.remove(t),this._targetTrackerManipulator!=null&&this._targetTrackerManipulator===t&&(this._targetTrackerManipulator=null))}_clearCursorTracker(){this.analysisViewData.cursorTarget=M(this.analysisViewData.cursorTarget)}_createManipulator(e,t,i){const s=Mt(this.view,e);return s.metadata=i,this._manipulatorHandles.add([t(s),s.events.on("grab-changed",r=>this._manipulatorGrabChanged(s,r)),s.events.on("immediate-click",r=>this._manipulatorClick(s,r))],s),this.manipulators.add(s),s}_createTargetManipulator(e){const t=this.configuration,i={size:t.target.size,customColor1:t.target.visibleColor,customColor2:t.target.occludedColor,customColor3:t.target.undefinedColor,visible:!0},s={target:e,type:"target"},r=this._createManipulator(i,l=>this._createTargetManipulatorDragPipeline(l),s);return e.position!=null?r.elevationAlignedLocation=e.position:r.available=!1,r}_getTargetManipulator(e){let t=null;return this.manipulators.forEach(i=>{const s=i.manipulator;t==null&&s.metadata.type==="target"&&s.metadata.target===e&&(t=s)}),t}_createObserverManipulator(){const e=this.configuration,t={size:e.observer.size,color:e.observer.color,visible:!0};return this._createManipulator(t,i=>this._createObserverManipulatorDragPipeline(i),{type:"observer",intersection:null})}_updateObserverManipulatorStyle(){const e=this._observerManipulator,t=this.configuration.observer,i={size:t.size,color:t.color,visible:e.available};e.renderObjects=Ge(i)}_screenToIntersection(){return e=>{const t=this._intersector.getScreenPointIntersection(e.screenEnd);return t==null?null:{...e,intersection:t}}}_createTargetManipulatorDragPipeline(e){return Re(e,(t,i,s)=>{i.next(this._screenToIntersection()).next(this._updateTargetDragStep(e)).next(()=>this._updateLaserLineRenderer()),s.next(this._cancelTargetDragStep(e.metadata.target)).next(()=>this._updateLaserLineRenderer())})}_createObserverManipulatorDragPipeline(e){return Re(e,(t,i,s)=>{i.next(this._screenToIntersection()).next(this._updateObserverDragStep()).next(()=>this._updateLaserLineRenderer()),s.next(this._cancelObserverDragStep()).next(()=>this._updateLaserLineRenderer())})}_updateObserverDragStep(){return e=>(e.intersection.mapPoint!=null?(this.analysis.observer==null&&(this.analysis.observer=new Ve),this._updateFromIntersection(this.analysis.observer,e.intersection)):this.analysis.observer=null,e)}_cancelObserverDragStep(){const e=this.analysis.observer!=null&&this.analysis.observer.position!=null?this.analysis.observer.clone():null;return t=>(this.analysis.observer=e,t)}_updateTargetDragStep(e){return t=>{this._updateFromIntersection(e.metadata.target,t.intersection);const i=t.intersection.mapPoint;return i!=null&&(e.elevationAlignedLocation=i),t}}_cancelTargetDragStep(e){const t=ze(e.position,i=>i.clone());return i=>(e.position=t,i)}_manipulatorGrabChanged(e,t){switch(t.action){case"start":this._grabbedManipulator=e;break;case"end":this._grabbedManipulator===e&&(this._grabbedManipulator=null)}}_updateManipulatorState(e,t){const{isValid:i,isTargetVisible:s}=t.computationResult;e.state=i?s?Z.Custom1:Z.Custom2:Z.Custom3}_getLineOfSightManipulatorStateDependencies(e){const{isValid:t,isTargetVisible:i}=e.computationResult;return{isValid:t,isTargetVisible:i}}_laserLineRendererDependencies(){return{laserlineVisualElement:this._laserlineVisualElement,grabbedManipulator:this._grabbedManipulator,shouldRenderTracker:this._shouldRenderTracker,observerPosition:this.analysis.observer!=null?this.analysis.observer.position:null,visible:this.visible}}_updateLaserLineRenderer(e=this._laserLineRendererDependencies()){const{laserlineVisualElement:t,grabbedManipulator:i,shouldRenderTracker:s,observerPosition:r,visible:l}=e;if(t==null)return;const a=i??(s&&r!=null?this._targetTrackerManipulator:null);this.configuration.laserLine.enabled&&a!=null&&l?(t.visible=!0,t.heightManifoldTarget=a.renderLocation,a!==this._observerManipulator?t.lineVerticalPlaneSegment=ht(this._observerManipulator.renderLocation,a.renderLocation,Dt):t.lineVerticalPlaneSegment=null):(t.visible=!1,t.heightManifoldTarget=null,t.lineVerticalPlaneSegment=null)}_createVisualElements(){const e=this.configuration.laserLine;this._removeVisualElements(),this._laserlineVisualElement=new Vt({view:this.view,attached:!0,visible:this.visible,style:{glowColor:u.toUnitRGB(e.glowColor),glowWidth:e.glowWidth,innerColor:u.toUnitRGB(e.innerColor),innerWidth:e.innerWidth,globalAlpha:e.globalAlpha}})}_removeVisualElements(){this._laserlineVisualElement!=null&&(this._laserlineVisualElement.destroy(),this._laserlineVisualElement=null)}_onObserverLocationChange(e){e!=null?(this._observerManipulator.metadata.intersection=null,this._observerManipulator.available=!0,this._observerManipulator.elevationAlignedLocation=e):this._observerManipulator.available=!1}_onTargetLocationChange(e,t){e!=null?(t.elevationAlignedLocation=e,t!==this._targetTrackerManipulator&&(t.available=!0)):t.available=!1}_addPointFromClickEvent(e){const t=this._intersector.getScreenPointIntersection(e);if(t!=null&&t.mapPoint!=null)if(this.analysis.observer!=null&&this.analysis.observer.position!=null){this._clearCursorTracker();const i=new Le;this._updateFromIntersection(i,t),this.analysis.targets.add(i)}else{const i=new Ve;this._updateFromIntersection(i,t),this.analysis.observer=i}}_clickHandler(e){this.active&&e.button!==ue.Right&&(this._addPointFromClickEvent(Te(e)),e.stopPropagation())}_doubleClickHandler(e){this.active&&e.button!==ue.Right&&(this.stop(),e.stopPropagation())}_keyDownHandler(e){this.active&&e.key==="Escape"&&(this.stop(),e.stopPropagation())}_pointerMoveHandler(e){if(this.hasGrabbedManipulators||(this._latestPointerMovePointerType=e.pointerType,this._updateLaserLineRenderer(),!this._showTracker||this.analysis.observer==null||this.analysis.observer.position==null))return;const t=Te(e),i=this._intersector.getScreenPointIntersection(t);i!=null&&i.mapPoint!=null&&(this.analysisViewData.cursorTarget==null&&(this.analysisViewData.cursorTarget=new Le),this._updateFromIntersection(this.analysisViewData.cursorTarget,i),this._updateLaserLineRenderer())}_updateFromIntersection(e,t){if(t.mapPoint==null)return e.position=null,e.elevationInfo=null,void(e.feature=null);switch(t.type){case J.OBJECT:if(t.graphic!=null){const s=t.graphic,r=bt(s);r.mode==="on-the-ground"&&(r.mode="relative-to-ground",r.offset=0),e.elevationInfo=new Ie(r),e.feature=s}else e.elevationInfo=null,e.feature=null;break;case J.TERRAIN:case J.I3S:e.elevationInfo=new Ie({mode:"on-the-ground"}),e.feature=null;break;default:e.elevationInfo=null,e.feature=null}const i=t.mapPoint.clone();i.z=ft(this.view,i,{mode:"absolute-height",offset:0},e.elevationInfo),e.position=i}_manipulatorClick(e,t){if(e.metadata.type==="observer"||e.grabbing||e.dragging||t.button!==ue.Right||this.analysis.targets.length<=1)return;const{target:i}=e.metadata;this.analysis.targets.remove(i),t.stopPropagation()}get testInfo(){return{laserLineVisualElement:this._laserlineVisualElement,getTargetManipulator:e=>this._getTargetManipulator(e)}}};n([o({constructOnly:!0})],C.prototype,"view",void 0),n([o({constructOnly:!0})],C.prototype,"analysis",void 0),n([o({readOnly:!0})],C.prototype,"state",null),n([o({readOnly:!0})],C.prototype,"cursor",null),n([o()],C.prototype,"removeIncompleteOnCancel",void 0),n([o({readOnly:!0})],C.prototype,"updating",null),n([o({type:G})],C.prototype,"configuration",void 0),n([o({constructOnly:!0})],C.prototype,"analysisViewData",void 0),n([o({readOnly:!0})],C.prototype,"_showTracker",null),n([o()],C.prototype,"_latestPointerMovePointerType",void 0),n([o()],C.prototype,"_shouldRenderTracker",null),n([o()],C.prototype,"_laserlineVisualElement",void 0),n([o()],C.prototype,"_grabbedManipulator",void 0),C=n([I("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightTool")],C);const Dt=dt();class kt{constructor(t,i,s,r){this.visibleLineVisualElement=t,this.occludedLineVisualElement=i,this.undefinedLineVisualElement=s,this.targetVisualElement=r}destroy(){this.visibleLineVisualElement.destroy(),this.occludedLineVisualElement.destroy(),this.undefinedLineVisualElement.destroy(),this.targetVisualElement.destroy()}}let E=class extends P{constructor(e){super(e),this._lineOfSightVisualElements=new Array,this._computationHandles=new K,this._updatingHandles=new be}initialize(){this.addHandles(this._connectComputations()),this._createObserverVisualization()}destroy(){this._updatingHandles=M(this._updatingHandles),this._computationHandles=M(this._computationHandles),this._observerVisualElement=M(this._observerVisualElement)}get visible(){return this.analysisViewData.visible}get updating(){return this._updatingHandles.updating}get interactiveAndEditable(){return this.analysisViewData.interactive&&this.analysisViewData.editable}get test(){return{disablePartialOcclusion:()=>{for(const e of this._lineOfSightVisualElements)e.visibleLineVisualElement.renderOccluded=de.Occlude,e.occludedLineVisualElement.renderOccluded=de.Occlude,e.undefinedLineVisualElement.renderOccluded=de.Occlude},visualizations:this._lineOfSightVisualElements}}get _configuration(){return this.analysisViewData.configuration}_createLineOfSightVisualization(){const e=this._configuration,t=this.view,i={view:t,attached:!0,width:e.outerWidth,innerWidth:e.innerWidth},s=u.toUnitRGBA(e.visibleOuterColor),r=u.toUnitRGBA(e.visibleInnerColor),l=u.toUnitRGBA(e.occludedOuterColor),a=u.toUnitRGBA(e.occludedInnerColor),h=u.toUnitRGBA(e.undefinedOuterColor),p=u.toUnitRGBA(e.undefinedInnerColor),c=new ce({...i,color:s,innerColor:r}),d=new ce({...i,color:l,innerColor:a}),v=new ce({...i,color:h,innerColor:p}),g=new Ee({view:t,attached:!0,...He,size:8}),f=new kt(c,d,v,g);return this._lineOfSightVisualElements.push(f),f}_destroyLineOfSightVisualization(e){e.destroy(),this._lineOfSightVisualElements.splice(this._lineOfSightVisualElements.indexOf(e),1)}_updateLineOfSightVisualization(e,t,i){const s=this._configuration,{computationResult:r,inputPoints:l}=e,{start:a,end:h,intersection:p,isValid:c,isTargetVisible:d}=r,{observer:v}=l,g=Gt;g[12]=v[0],g[13]=v[1],g[14]=v[2];const f=X(zt,a,v),O=X(xt,h,v),w=X(Ft,p,v),{visibleLineVisualElement:_,occludedLineVisualElement:S,undefinedLineVisualElement:V,targetVisualElement:D}=t,Ne=this.analysisViewData.elevationAlignedObserver==null||e.elevationAlignedTargetLocation==null,Q=this.visible&&!Ne;_.visible=Q,S.visible=Q,V.visible=Q,D.visible=Q,D.attached=!i.interactiveAndEditable,Q&&(_.geometry=null,S.geometry=null,V.geometry=null,D.geometry=e.elevationAlignedTargetLocation,c?d?(_.geometry=[[k(f),k(O)]],_.transform=g,_.color=u.toUnitRGBA(s.visibleOuterColor),D.color=u.toUnitRGBA(s.visibleInnerColor)):(_.geometry=[[k(f),k(w)]],_.transform=g,_.color=u.toUnitRGBA(s.occludedOuterColor),S.geometry=[[k(w),k(O)]],S.transform=g,D.color=u.toUnitRGBA(s.occludedInnerColor)):(V.geometry=[[k(f),k(O)]],V.transform=g,D.color=u.toUnitRGBA(s.undefinedInnerColor)))}_getLineOfSightVisualizationDependencies(e){const{computationResult:t}=e,{occludedOuterColor:i,visibleOuterColor:s}=this._configuration;return{computationResult:t,occludedOuterColor:i,visibleOuterColor:s,visible:this.visible,interactiveAndEditable:this.interactiveAndEditable}}_connectComputation(e){const t=this._computationHandles;if(t.has(e))return;const i=this._createLineOfSightVisualization();t.add([this._updatingHandles.add(()=>this._getLineOfSightVisualizationDependencies(e),s=>this._updateLineOfSightVisualization(e,i,s),{initial:!0,equals:()=>!1}),ke(()=>this._destroyLineOfSightVisualization(i))],e)}_disconnectComputation(e){this._computationHandles.remove(e)}_connectComputations(){return this._updatingHandles.addOnCollectionChange(()=>this.analysisViewData.computations,e=>this._onComputationsCollectionChange(e),{initial:!0,final:!0})}_onComputationsCollectionChange({added:e,removed:t}){for(const i of t)this._disconnectComputation(i);for(const i of e)this._connectComputation(i)}_createObserverVisualization(){const e=u.toUnitRGBA(this._configuration.visibleInnerColor),t=new Ee({view:this.view,attached:!1,color:e,...He});this._observerVisualElement=t,this.addHandles(this._updatingHandles.add(()=>({observer:this.analysisViewData.elevationAlignedObserver,interactiveAndEditable:this.interactiveAndEditable,visible:this.visible}),({observer:i,interactiveAndEditable:s,visible:r})=>{i!=null&&!s&&r?(t.geometry=i,this._observerVisualElement.attached=!0):t.attached=!1},H))}};n([o({constructOnly:!0})],E.prototype,"analysis",void 0),n([o({constructOnly:!0})],E.prototype,"analysisViewData",void 0),n([o({constructOnly:!0})],E.prototype,"view",void 0),n([o({readOnly:!0})],E.prototype,"visible",null),n([o()],E.prototype,"updating",null),n([o()],E.prototype,"interactiveAndEditable",null),n([o()],E.prototype,"test",null),n([o()],E.prototype,"_configuration",null),E=n([I("esri.views.3d.analysis.LineOfSight.LineOfSightVisualization")],E);const He={size:6,pixelSnappingEnabled:!1,primitive:"circle",elevationInfo:{mode:"absolute-height",offset:0},outlineSize:0},zt=y(),xt=y(),Ft=y(),Gt=gt();let b=class extends mt(De.EventedMixin(P)){constructor(e){super(e),this.type="line-of-sight-view-3d",this.analysis=null,this.tool=null,this.computations=new vt,this.elevationAlignedObserver=null,this.configuration=new R,this.observerEngineLocation=y(),this.cursorTarget=null,this.editable=!0}initialize(){const e=this.view,t=this.analysis;this._analysisController=new m({analysis:t,analysisViewData:this,view:e}),this._analysisVisualization=new E({analysis:t,analysisViewData:this,view:e}),this.addHandles([this._analysisController.on("result-changed",i=>{i.target!==this.cursorTarget&&this.emit("result-changed",i)}),It(this,C)])}destroy(){Pt(this),this._analysisController=M(this._analysisController),this._analysisVisualization=M(this._analysisVisualization)}get results(){return this.computations.map(e=>e.result)}get priority(){return this._analysisController.priority}set priority(e){this._analysisController.priority=e}get updating(){return this._analysisController!=null&&this._analysisController.updating||this._analysisVisualization!=null&&this._analysisVisualization.updating}getResultForTarget(e){const t=this.computations.find(i=>i.target===e);return ze(t,i=>i.result)}get testInfo(){return{visualization:this._analysisVisualization,controller:this._analysisController}}};n([o({readOnly:!0})],b.prototype,"type",void 0),n([o({constructOnly:!0,nonNullable:!0})],b.prototype,"analysis",void 0),n([o()],b.prototype,"tool",void 0),n([o({readOnly:!0})],b.prototype,"results",null),n([o()],b.prototype,"priority",null),n([o()],b.prototype,"computations",void 0),n([o()],b.prototype,"elevationAlignedObserver",void 0),n([o()],b.prototype,"configuration",void 0),n([o()],b.prototype,"observerEngineLocation",void 0),n([o()],b.prototype,"cursorTarget",void 0),n([o()],b.prototype,"updating",null),n([o()],b.prototype,"editable",void 0),n([o()],b.prototype,"_analysisController",void 0),n([o()],b.prototype,"_analysisVisualization",void 0),b=n([I("esri.views.3d.analysis.LineOfSightAnalysisView3D")],b);const Yt=b;export{Yt as default};
