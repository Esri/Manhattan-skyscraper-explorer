import{dV as V,bW as mt,aJ as o,aK as l,aM as L,aP as de,bB as H,bD as St,bs as rr,aQ as Ye,gP as Be,ai as w,fb as ot,c4 as $t,by as me,bC as te,aL as fe,ae as pe,bo as ye,ff as nr,bv as ie,f7 as Nt,dR as ve,df as Pt,ul as ft,g5 as ir,gX as ar,es as jt,eu as Ot,et as or,um as sr,f9 as re,fg as gt,un as $e,gZ as lr,fW as pr,bt as dr,c5 as De,g4 as ur,h4 as hr,bR as Ft,aA as wt,bX as _t,bn as cr}from"./index-f3c752ba.js";import{p as Z}from"./geohashUtils-77d8429b.js";import{m as yr}from"./FeatureStore-0060a525.js";import{e as mr}from"./QueryEngine-f1dffdc0.js";import{c as fr,o as Ne}from"./clientSideDefaults-617f35b4.js";import"./BoundsStore-27a00ede.js";import"./PooledRBush-fcd2f988.js";import"./quickselect-a3dd9b31.js";import"./optimizedFeatureQueryEngineAdapter-46fe2fee.js";import"./centroid-3dcadaf5.js";import"./normalizeUtils-fa52885c.js";import"./normalizeUtilsCommon-f2114a16.js";import"./WhereClause-0153ffeb.js";import"./executionError-e8d36121.js";import"./json-48e3ea08.js";import"./QueryEngineCapabilities-42e44ded.js";import"./utils-f42e43a2.js";import"./generateRendererUtils-65cff66e.js";const gr="ESRI__DESTINATION_ID",wr="ESRI__ORIGIN_ID";let Pe=class W{constructor(){this._featureLookup=new Map}static getInstance(){return W.instance||(W.instance=new W),W.instance}static resetInstance(){W.instance&&(W.instance=null)}deleteFromStore(t){t.forEach(r=>{this._featureLookup.delete(r)})}readFromStoreByList(t){const r=[];return t.forEach(n=>{const i=this.readFromStoreById(n);i&&r.push(i)}),r}readFromStoreById(t){return this._featureLookup.get(t)??null}writeToStore(t,r,n){const i=[];return t.forEach(a=>{if(!a||!a.id)return;a.properties||(a.properties=[]);let s,u=null;if(n&&(u=a.properties[n]?V(a.properties[n]):null),"originId"in a&&"destinationId"in a&&(a.properties[wr]=a.originId,a.properties[gr]=a.destinationId),a.properties[r]=a.id,a.id&&this._featureLookup.has(a.id)&&this._featureLookup.get(a.id).attributes){const y=this._featureLookup.get(a.id);s=new mt(u?JSON.parse(JSON.stringify(u)):y?.geometry?JSON.parse(JSON.stringify(y.geometry)):null,JSON.parse(JSON.stringify(Object.assign(y.attributes,a.properties))),null,a.properties[r])}else s=new mt(u?JSON.parse(JSON.stringify(u)):null,a.properties,null,a.properties[r]);this._featureLookup.set(a.id,s),i.push(s)}),i}},Te=class extends de{constructor(t){super(t),this.resultRows=[]}};o([l()],Te.prototype,"resultRows",void 0),Te=o([L("esri.rest.knowledgeGraph.GraphQueryResult")],Te);const bt=Te;let Ee=class extends de{constructor(t){super(t),this.resultRowsStream=new ReadableStream}};o([l()],Ee.prototype,"resultRowsStream",void 0),Ee=o([L("esri.rest.knowledgeGraph.GraphQueryResult")],Ee);const Tt=Ee;let Y=class extends H{constructor(t){super(t),this.name=null,this.unique=null,this.ascending=null,this.description=null,this.fieldNames=null}};o([l({type:String,json:{write:!0}})],Y.prototype,"name",void 0),o([l({type:Boolean,json:{write:!0}})],Y.prototype,"unique",void 0),o([l({type:Boolean,json:{write:!0}})],Y.prototype,"ascending",void 0),o([l({type:String,json:{write:!0}})],Y.prototype,"description",void 0),o([l({type:[String],json:{write:!0}})],Y.prototype,"fieldNames",void 0),Y=o([L("esri.rest.knowledgeGraph.FieldIndex")],Y);const At=Y;let $=class extends H{constructor(t){super(t),this.name=null,this.alias=null,this.fieldType=null,this.geometryType=null,this.hasM=null,this.hasZ=null,this.nullable=null,this.editable=null,this.required=null,this.defaultVisibility=null,this.systemMaintained=null,this.role=null,this.defaultValue=null}};o([l({type:String,json:{write:!0}})],$.prototype,"name",void 0),o([l({type:String,json:{write:!0}})],$.prototype,"alias",void 0),o([l({type:String,json:{write:!0}})],$.prototype,"fieldType",void 0),o([l({type:String,json:{write:!0}})],$.prototype,"geometryType",void 0),o([l({type:Boolean,json:{write:!0}})],$.prototype,"hasM",void 0),o([l({type:Boolean,json:{write:!0}})],$.prototype,"hasZ",void 0),o([l({type:Boolean,json:{write:!0}})],$.prototype,"nullable",void 0),o([l({type:Boolean,json:{write:!0}})],$.prototype,"editable",void 0),o([l({type:Boolean,json:{write:!0}})],$.prototype,"required",void 0),o([l({type:Boolean,json:{write:!0}})],$.prototype,"defaultVisibility",void 0),o([l({type:Boolean,json:{write:!0}})],$.prototype,"systemMaintained",void 0),o([l()],$.prototype,"role",void 0),o([l({type:Object,json:{type:String,write:{writer:(e,t)=>{t.defaultValue=e!=null?e.toString():null}}}})],$.prototype,"defaultValue",void 0),$=o([L("esri.rest.knowledgeGraph.GraphProperty")],$);const zt=$;let U=class extends H{constructor(t){super(t),this.name=null,this.alias=null,this.role=null,this.strict=null,this.properties=null,this.fieldIndexes=null}};o([l({type:String,json:{write:!0}})],U.prototype,"name",void 0),o([l({type:String,json:{write:!0}})],U.prototype,"alias",void 0),o([l({type:String,json:{write:!0}})],U.prototype,"role",void 0),o([l({type:Boolean,json:{write:!0}})],U.prototype,"strict",void 0),o([l({type:[zt],json:{write:!0}})],U.prototype,"properties",void 0),o([l({type:[At],json:{write:!0}})],U.prototype,"fieldIndexes",void 0),U=o([L("esri.rest.knowledgeGraph.GraphObjectType")],U);const Qt=U;let He=class extends Qt{constructor(t){super(t)}};He=o([L("esri.rest.knowledgeGraph.EntityType")],He);const st=He;let ke=class extends Qt{constructor(t){super(t),this.endPoints=[]}};o([l()],ke.prototype,"endPoints",void 0),ke=o([L("esri.rest.knowledgeGraph.RelationshipType")],ke);const lt=ke;let F=class extends H{constructor(t){super(t),this.timestamp=null,this.spatialReference=null,this.strict=null,this.objectIdField=null,this.globalIdField=null,this.arcgisManaged=null,this.identifierInfo=null,this.searchIndexes=null,this.entityTypes=null,this.relationshipTypes=null}};o([l({type:Date,json:{type:Number,write:{writer:(e,t)=>{t.timestamp=e?.getTime()}}}})],F.prototype,"timestamp",void 0),o([l({type:St,json:{write:!0}})],F.prototype,"spatialReference",void 0),o([l({type:Boolean,json:{write:!0}})],F.prototype,"strict",void 0),o([l({type:String,json:{write:!0}})],F.prototype,"objectIdField",void 0),o([l({type:String,json:{write:!0}})],F.prototype,"globalIdField",void 0),o([l()],F.prototype,"arcgisManaged",void 0),o([l()],F.prototype,"identifierInfo",void 0),o([l()],F.prototype,"searchIndexes",void 0),o([l({type:[st],json:{write:!0}})],F.prototype,"entityTypes",void 0),o([l({type:[lt],json:{write:!0}})],F.prototype,"relationshipTypes",void 0),F=o([L("esri.rest.knowledgeGraph.DataModel")],F);const Ut=F;let D=class extends H{constructor(t){super(t),this.capabilities=[],this.supportsSearch=!1,this.supportedQueryFormats=[],this.allowGeometryUpdates=!1,this.searchMaxRecordCount=null,this.serviceCapabilities=null,this.maxRecordCount=null,this.description="",this.copyrightText="",this.units="",this.spatialReference=null,this.currentVersion=null,this.dateFieldsTimeReference=null,this.serviceItemId="",this.supportsDocuments=!1,this.dataEditingNotSupported=!1,this.schemaEditingNotSupported=!1}};o([l({type:[String],json:{write:!0}})],D.prototype,"capabilities",void 0),o([l({type:Boolean,json:{write:!0}})],D.prototype,"supportsSearch",void 0),o([l({type:[String],json:{write:!0}})],D.prototype,"supportedQueryFormats",void 0),o([l({type:Boolean,json:{write:!0}})],D.prototype,"allowGeometryUpdates",void 0),o([l({type:Number,json:{write:!0}})],D.prototype,"searchMaxRecordCount",void 0),o([l({type:Object,json:{write:!0}})],D.prototype,"serviceCapabilities",void 0),o([l({type:Number,json:{write:!0}})],D.prototype,"maxRecordCount",void 0),o([l({type:String,json:{write:!0}})],D.prototype,"description",void 0),o([l({type:String,json:{write:!0}})],D.prototype,"copyrightText",void 0),o([l({type:String,json:{write:!0}})],D.prototype,"units",void 0),o([l({type:Object,json:{write:!0}})],D.prototype,"spatialReference",void 0),o([l({type:Number,json:{write:!0}})],D.prototype,"currentVersion",void 0),o([l({type:Object,json:{write:!0}})],D.prototype,"dateFieldsTimeReference",void 0),o([l({type:String,json:{write:!0}})],D.prototype,"serviceItemId",void 0),o([l({type:Boolean,json:{write:!0}})],D.prototype,"supportsDocuments",void 0),o([l({type:Boolean,json:{write:!0}})],D.prototype,"dataEditingNotSupported",void 0),o([l({type:Boolean,json:{write:!0}})],D.prototype,"schemaEditingNotSupported",void 0),D=o([L("esri.rest.knowledgeGraph.ServiceDefinition")],D);const qt=D;let ae=class extends H{constructor(t){super(t),this.dataModel=null,this.serviceDefinition=null}};o([l({type:String,json:{write:!0}})],ae.prototype,"url",void 0),o([l({type:Ut,json:{write:!0}})],ae.prototype,"dataModel",void 0),o([l({type:qt,json:{write:!0}})],ae.prototype,"serviceDefinition",void 0),ae=o([L("esri.rest.knowledgeGraph.KnowledgeGraph")],ae);const _r=ae,Et="esri/rest/knowledgeGraph/wasmInterface/";let je;async function B(){const e=je;if(e)return e;const t=rr("wasm-simd");return je=br(t),je}async function br(e){if(e){const{default:r}=await Ye(()=>import("./arcgis-knowledge-client-core-simd-5da75e4d.js"),["./arcgis-knowledge-client-core-simd-5da75e4d.js","./index-f3c752ba.js","./index-a616bda8.css"],import.meta.url).then(n=>n.a);return r({locateFile:n=>Be(Et+n)})}const{default:t}=await Ye(()=>import("./arcgis-knowledge-client-core-c1530bf3.js"),["./arcgis-knowledge-client-core-c1530bf3.js","./index-f3c752ba.js","./index-a616bda8.css"],import.meta.url).then(r=>r.a);return t({locateFile:r=>Be(Et+r)})}function Yt(e,t){const r=new t.ArrayValue;return r.deleteLater(),e.forEach(n=>{r.add_value(dt(n,t))}),r}function Bt(e,t){const r=new t.ObjectValue;r.deleteLater();for(const[n,i]of Object.entries(e))r.set_key_value(n,dt(i,t));return r}function pt(e,t){if(e instanceof $t)return Mr(e,t);if(e instanceof me)return Ir(e,t);if(e instanceof te||e instanceof fe)return kr(e,t);throw new w("knowledge-graph:unsupported-geometry","Only Point, Multipoint, Polyline, and Polygon geometry are supported by ArcGIS Knowledge",{geometry:e})}function Tr(e,t){t.input_quantization_parameters={xy_resolution:e.xyResolution,x_false_origin:e.xFalseOrigin,y_false_origin:e.yFalseOrigin,z_resolution:e.zResolution,z_false_origin:e.zFalseOrigin,m_resolution:e.mResolution,m_false_origin:e.mFalseOrigin}}function Er(e,t,r){if(!e.extent)throw new w("knowledge-graph:illegal-output-quantization","The Output quantization provided to the encoder had an illegal value as part of its extent",e.extent);if(!e.quantizeMode)throw new w("knowledge-graph:illegal-output-quantization","The Output quantization contained an illegal mode setting",e.quantizeMode);if(!e.tolerance)throw new w("knowledge-graph:illegal-output-quantization","The Output quantization contained an illegal tolerance setting",e.quantizeMode);t.output_quantization_parameters={extent:{xmax:e.extent.xmax,ymax:e.extent.ymax,xmin:e.extent.xmin,ymin:e.extent.ymin},quantize_mode:r.esriQuantizeMode[e.quantizeMode],tolerance:e.tolerance}}function dt(e,t){if(e==null)return"";if(typeof e!="object"||e instanceof Date)return e;if(e instanceof ot)return pt(e,t);if(Array.isArray(e)){const r=new t.ArrayValue;return r.deleteLater(),e.forEach(n=>{r.add_value(dt(n,t))}),r}return Bt(e,t)}function kr(e,t){const r=new t.GeometryValue;r.deleteLater(),r.has_z=e.hasZ,r.has_m=e.hasM;const n=[],i=[];let a=[];e instanceof te?(r.geometry_type=t.esriGeometryType.esriGeometryPolyline,a=e.paths):e instanceof fe&&(r.geometry_type=t.esriGeometryType.esriGeometryPolygon,a=e.rings);let s=0,u=0;return a.forEach(y=>{let d=0;y.forEach(c=>{d++,c.forEach(b=>{n[u]=b,u++})}),i[s]=d,s++}),r.coords=new Float64Array(n),r.lengths=new Uint32Array(i),r}function Mr(e,t){const r=new t.GeometryValue;r.deleteLater(),r.geometry_type=r.geometry_type=t.esriGeometryType.esriGeometryMultipoint,r.has_z=e.hasZ,r.has_m=e.hasM;const n=[],i=[];i[0]=e.points.length;let a=0;return e.points.forEach(s=>{s.forEach(u=>{n[a]=u,a++})}),r.coords=new Float64Array(n),r.lengths=new Uint32Array(i),r}function Ir(e,t){const r=new t.GeometryValue;r.deleteLater(),r.geometry_type=t.esriGeometryType.esriGeometryPoint,r.has_z=e.hasZ,r.has_m=e.hasM;const n=[],i=[];i[0]=1,n[0]=e.x,n[1]=e.y;let a=2;return e.hasZ&&(n[a]=e.z,a++),e.hasM&&(n[a]=e.m,a++),r.coords=new Float64Array(n),r.lengths=new Uint32Array(i),r}let Me=class extends H{constructor(t){super(t),this.properties=null}};o([l({json:{write:!0}})],Me.prototype,"properties",void 0),Me=o([L("esri.rest.knowledgeGraph.GraphObject")],Me);const ut=Me;let ce=class extends ut{constructor(t){super(t),this.typeName=null,this.id=null}};o([l({type:String,json:{write:!0}})],ce.prototype,"typeName",void 0),o([l({type:String,json:{write:!0}})],ce.prototype,"id",void 0),ce=o([L("esri.rest.knowledgeGraph.GraphNamedObject")],ce);const Ht=ce;let Ie=class extends Ht{constructor(t){super(t),this.layoutGeometry=null}};o([l({type:me,json:{write:!0}})],Ie.prototype,"layoutGeometry",void 0),Ie=o([L("esri.rest.knowledgeGraph.Entity")],Ie);const Jt=Ie;let oe=class extends Ht{constructor(t){super(t),this.originId=null,this.destinationId=null,this.layoutGeometry=null}};o([l({type:String,json:{write:!0}})],oe.prototype,"originId",void 0),o([l({type:String,json:{write:!0}})],oe.prototype,"destinationId",void 0),o([l({type:te,json:{write:!0}})],oe.prototype,"layoutGeometry",void 0),oe=o([L("esri.rest.Relationship.Relationship")],oe);const Vt=oe;function we(e,t){if(!e.typeName)throw new w("knowledge-graph:no-type-name","You must indicate the entity/relationship named object type to apply edits");if(e instanceof Jt){const r=new t.EntityValue;r.deleteLater(),r.type_name=e.typeName;for(const[n,i]of Object.entries(e.properties))r.set_key_value(n,kt(i,t));return e.id&&r.set_id(e.id),r}if(e instanceof Vt){const r=new t.RelationshipValue;r.deleteLater(),r.type_name=e.typeName;for(const[n,i]of Object.entries(e.properties))r.set_key_value(n,kt(i,t));return e.id&&r.set_id(e.id),e.originId&&e.destinationId&&r.set_related_entity_ids(e.originId,e.destinationId),r}throw new w("knowledge-graph:applyEdits-encoding-failure","Could not determine the type of a named graph object passed to the encoder")}function Cr(e){return{xy_resolution:e.xyResolution,x_false_origin:e.xFalseOrigin,y_false_origin:e.yFalseOrigin,z_resolution:e.zResolution,z_false_origin:e.zFalseOrigin,m_resolution:e.mResolution,m_false_origin:e.mFalseOrigin}}function kt(e,t){return e==null?"":typeof e!="object"||e instanceof Date?e:e instanceof ot?pt(e,t):""}let K=class extends de{constructor(t){super(t),this.name=null,this.supportedCategory=null,this.analyzers=[],this.searchProperties=new Map}};o([l()],K.prototype,"name",void 0),o([l()],K.prototype,"supportedCategory",void 0),o([l()],K.prototype,"analyzers",void 0),o([l()],K.prototype,"searchProperties",void 0),K=o([L("esri.rest.knowledgeGraph.SearchIndex")],K);const Lr=K;var xe,Ge,Re,Je,Ve,We,Ke;(function(e){e[e.Regular=0]="Regular",e[e.Provenance=1]="Provenance",e[e.Document=2]="Document"})(xe||(xe={})),function(e){e[e.esriFieldTypeSmallInteger=0]="esriFieldTypeSmallInteger",e[e.esriFieldTypeInteger=1]="esriFieldTypeInteger",e[e.esriFieldTypeSingle=2]="esriFieldTypeSingle",e[e.esriFieldTypeDouble=3]="esriFieldTypeDouble",e[e.esriFieldTypeString=4]="esriFieldTypeString",e[e.esriFieldTypeDate=5]="esriFieldTypeDate",e[e.esriFieldTypeOID=6]="esriFieldTypeOID",e[e.esriFieldTypeGeometry=7]="esriFieldTypeGeometry",e[e.esriFieldTypeBlob=8]="esriFieldTypeBlob",e[e.esriFieldTypeRaster=9]="esriFieldTypeRaster",e[e.esriFieldTypeGUID=10]="esriFieldTypeGUID",e[e.esriFieldTypeGlobalID=11]="esriFieldTypeGlobalID",e[e.esriFieldTypeXML=12]="esriFieldTypeXML",e[e.esriFieldTypeBigInteger=13]="esriFieldTypeBigInteger"}(Ge||(Ge={})),function(e){e[e.esriGeometryNull=0]="esriGeometryNull",e[e.esriGeometryPoint=1]="esriGeometryPoint",e[e.esriGeometryMultipoint=2]="esriGeometryMultipoint",e[e.esriGeometryPolyline=3]="esriGeometryPolyline",e[e.esriGeometryPolygon=4]="esriGeometryPolygon",e[e.esriGeometryEnvelope=5]="esriGeometryEnvelope",e[e.esriGeometryAny=6]="esriGeometryAny",e[e.esriGeometryMultiPatch=7]="esriGeometryMultiPatch"}(Re||(Re={})),function(e){e[e.esriMethodHintUNSPECIFIED=0]="esriMethodHintUNSPECIFIED",e[e.esriUUIDESRI=1]="esriUUIDESRI",e[e.esriUUIDRFC4122=2]="esriUUIDRFC4122"}(Je||(Je={})),function(e){e[e.esriTypeUNSPECIFIED=0]="esriTypeUNSPECIFIED",e[e.esriTypeEntity=1]="esriTypeEntity",e[e.esriTypeRelationship=2]="esriTypeRelationship",e[e.esriTypeBoth=4]="esriTypeBoth"}(Ve||(Ve={})),function(e){e[e.esriGraphPropertyUNSPECIFIED=0]="esriGraphPropertyUNSPECIFIED",e[e.esriGraphPropertyRegular=1]="esriGraphPropertyRegular",e[e.esriGraphPropertyDocumentName=2]="esriGraphPropertyDocumentName",e[e.esriGraphPropertyDocumentTitle=3]="esriGraphPropertyDocumentTitle",e[e.esriGraphPropertyDocumentUrl=4]="esriGraphPropertyDocumentUrl",e[e.esriGraphPropertyDocumentText=5]="esriGraphPropertyDocumentText",e[e.esriGraphPropertyDocumentKeywords=6]="esriGraphPropertyDocumentKeywords",e[e.esriGraphPropertyDocumentContentType=7]="esriGraphPropertyDocumentContentType",e[e.esriGraphPropertyDocumentMetadata=8]="esriGraphPropertyDocumentMetadata",e[e.esriGraphPropertyDocumentFileExtension=9]="esriGraphPropertyDocumentFileExtension"}(We||(We={})),function(e){e[e.esriIdentifierInfoTypeUNSPECIFIED=0]="esriIdentifierInfoTypeUNSPECIFIED",e[e.esriIdentifierInfoTypeDatabaseNative=1]="esriIdentifierInfoTypeDatabaseNative",e[e.esriIdentifierInfoTypeUniformProperty=2]="esriIdentifierInfoTypeUniformProperty"}(Ke||(Ke={}));function vr(e){return e.deleteLater(),new Ut({timestamp:e.timestamp,spatialReference:new St(e.spatial_reference),strict:e.strict,objectIdField:e.objectid_property,globalIdField:e.globalid_property,arcgisManaged:e.arcgis_managed,identifierInfo:{identifierMappingInfo:{identifierInfoType:Ke[e.identifier_info?.identifier_mapping_info?.identifier_info_type?.value],databaseNativeIdentifier:e.identifier_info?.identifier_mapping_info?.database_native_identifier,uniformPropertyIdentifier:{identifierPropertyName:e.identifier_info?.identifier_mapping_info?.uniform_property_identifier?.identifier_property_name}},identifierGenerationInfo:{uuidMethodHint:Je[e.identifier_info?.identifier_generation_info?.uuid_method_hint?.value]}},searchIndexes:Or(e.search_indexes),entityTypes:Sr(e.entity_types),relationshipTypes:jr(e.relationship_types)})}function Dr(e){return e.deleteLater(),new st(Wt(e))}function xr(e){return e.deleteLater(),new At({name:e.name,unique:e.unique,ascending:e.ascending,description:e.description,fieldNames:$r(e.fields)})}function Wt(e){return{name:e.name,alias:e.alias,role:xe[e.role.value]?xe[e.role.value]:null,strict:e.strict,properties:Nr(e.properties),fieldIndexes:Pr(e.field_indexes)}}function Gr(e){return e.deleteLater(),new zt({alias:e.alias,name:e.name,fieldType:Ge[e.field_type.value]?Ge[e.field_type.value]:null,geometryType:Re[e.geometry_type.value]?Re[e.geometry_type.value]:null,hasM:e.has_m,hasZ:e.has_z,nullable:e.nullable,editable:e.editable,required:e.required,defaultVisibility:e.default_visibility,systemMaintained:e.system_maintained,role:We[e.role.value],defaultValue:e.default_value})}function Rr(e){e.deleteLater();const t=Wt(e),r=[];for(let n=0;n<e.end_points.size();n++){const i=e.end_points.get(n);r.push({originEntityType:i.origin_entity_type,destinationEntityType:i.dest_entity_type})}return new lt(Object.assign({endPoints:r},t))}function Sr(e){const t=[];for(let r=0;r<e.size();r++)t.push(Dr(e.get(r)));return t}function $r(e){const t=[];for(let r=0;r<e.size();r++)t.push(e.get(r));return t}function Nr(e){const t=[];for(let r=0;r<e.size();r++)t.push(Gr(e.get(r)));return t}function Pr(e){const t=[];for(let r=0;r<e.size();r++)t.push(xr(e.get(r)));return t}function jr(e){const t=[];for(let r=0;r<e.size();r++)t.push(Rr(e.get(r)));return t}function Or(e){const t=[];for(let r=0;r<e.size();r++){const n=new Lr,i=e.get(0);n.name=i.name,n.supportedCategory=Ve[i.supported_category.value];const a=i.analyzers.size();for(let s=0;s<a;s++)n.analyzers.push({name:i.analyzers.get(s).name});for(let s=0;s<i.search_properties.keys().size();s++){const u=i.search_properties.keys().get(s),y=i.search_properties.get(u),d=[];for(let c=0;c<y.property_names.size();c++)d.push(y.property_names.get(c));n.searchProperties.set(u,{propertyNames:d})}t.push(n)}return t}let Ze=class extends ut{constructor(t){super(t)}};Ze=o([L("esri.rest.knowledgeGraph.ObjectValue")],Ze);const Fr=Ze;let Ce=class extends H{constructor(t){super(t),this.path=null}};o([l({type:[ut],json:{write:!0}})],Ce.prototype,"path",void 0),Ce=o([L("esri.rest.knowledgeGraph.Path")],Ce);const Ar=Ce;var A;(function(e){e[e.ESRI_GEOMETRY_NULL=0]="ESRI_GEOMETRY_NULL",e[e.ESRI_GEOMETRY_POINT=1]="ESRI_GEOMETRY_POINT",e[e.ESRI_GEOMETRY_MULTIPOINT=2]="ESRI_GEOMETRY_MULTIPOINT",e[e.ESRI_GEOMETRY_POLYLINE=3]="ESRI_GEOMETRY_POLYLINE",e[e.ESRI_GEOMETRY_POLYGON=4]="ESRI_GEOMETRY_POLYGON",e[e.ESRI_GEOMETRY_ENVELOPE=5]="ESRI_GEOMETRY_ENVELOPE",e[e.ESRI_GEOMETRY_ANY=6]="ESRI_GEOMETRY_ANY",e[e.ESRI_GEOMETRY_MULTI_PATCH=7]="ESRI_GEOMETRY_MULTI_PATCH"})(A||(A={}));var X,Mt;(function(e){e[e.OBJECT=0]="OBJECT",e[e.ENTITY=1]="ENTITY",e[e.RELATIONSHIP=2]="RELATIONSHIP",e[e.PATH=3]="PATH",e[e.ARRAY=4]="ARRAY"})(X||(X={})),function(e){e[e.view=0]="view",e[e.edit=1]="edit"}(Mt||(Mt={}));function zr(e){const t={},r=ht(e,t),n=e.lengths,i=e.coords,a=n[0];t.points=[];let s=0;for(let u=0;u<a;u++){const y=[];for(let d=0;d<r;d++)y[d]=i[s],s++;t.points.push(y)}return new $t(t)}function Qr(e){const t={};let r=2;ht(e,t);const n=e.coords;return t.x=n[0],t.y=n[1],e.has_z&&(t.z=n[r],r++),e.has_m&&(t.m=n[r]),new me(t)}function Ur(e){return new te(Kt(e))}function qr(e){return new fe(Kt(e))}function Kt(e){const t={},r=ht(e,t),n=e.lengths,i=e.coords;let a="";if(e.geometry_type.value===A.ESRI_GEOMETRY_POLYGON)a="rings";else{if(e.geometry_type.value!==A.ESRI_GEOMETRY_POLYLINE)throw new w("KnowledgeGraph:illegal-geometry-type","Illegal Geometry type for multipath conversion");a="paths"}t[a]=[];let s=0;return n.forEach(u=>{const y=[];for(let d=0;d<u;d++){const c=[];for(let b=0;b<r;b++)c[b]=i[s],s++;y.push(c)}t[a].push(y)}),t}function ht(e,t){let r=2;return e.has_z?(t.hasZ=e.has_z,r++):t.hasZ=!1,e.has_m?(t.hasM=e.has_m,r++):t.hasM=!1,r}const _e=pe.getLogger("esri.rest.knowledgeGraph.WasmToQueryResponseObjConstructors"),Yr={decodedWasmObjToQueryResponseObj:(e,t)=>{if(e==null)return null;if(typeof e!="object"||"getDate"in e)return e;if("geometry_type"in e)switch(e.geometry_type.value){case null:return null;case A.ESRI_GEOMETRY_POINT:return Qr(e);case A.ESRI_GEOMETRY_MULTIPOINT:return zr(e);case A.ESRI_GEOMETRY_POLYLINE:return Ur(e);case A.ESRI_GEOMETRY_POLYGON:return qr(e);case A.ESRI_GEOMETRY_ENVELOPE:case A.ESRI_GEOMETRY_MULTI_PATCH:return _e.warnOnce("Envelope and Multipatch are not supported on knowledge entities, but one of those geometry types was detected. Result interpreted as null"),null;case A.ESRI_GEOMETRY_NULL:case A.ESRI_GEOMETRY_ANY:default:return _e.warnOnce("Unknown or blank geometry type returned - Result interpreted as null"),null}else{if(!("object_value_type"in e))return _e.warnOnce("A decoded value came back of a type that is not supported. Result interpreted as null"),null;switch(e.object_value_type.value){case X.OBJECT:return Hr(e,t);case X.ENTITY:return Zt(e,t);case X.RELATIONSHIP:return Xt(e,t);case X.PATH:return Jr(e,t);case X.ARRAY:return Br(e,t);default:return _e.warnOnce("Unknown graph object type detected!  Result interpreted as null"),null}}}};function Br(e,t){const r=[],n=e.count();for(let i=0;i<n;i++){const a=e.get_value_at(i);r.push(ct(a,t))}return r}function ct(e,t){return Yr.decodedWasmObjToQueryResponseObj(e,t)}function Zt(e,t){const r=e.type_name,n=yt(e,t),i=e.get_id();return new Jt(Object.assign({typeName:r,id:i},n))}function yt(e,t){const r={},n=e.key_count();for(let i=0;i<n;i++)r[e.get_key_at(i)]=ct(e.get_value_at(i),t);return{properties:r}}function Hr(e,t){return new Fr(yt(e,t))}function Jr(e,t){const r=e.entity_count(),n=e.relationship_count(),i=[];for(let a=0;a<r;a++)i.push(Zt(e.get_entity_at(a),t)),a<n&&i.push(Xt(e.get_relationship_at(a),t));return new Ar({path:i})}function Xt(e,t){const r=e.type_name,n=yt(e,t);return new Vt(Object.assign({typeName:r,id:e.get_id(),originId:e.get_origin_entity_id(),destinationId:e.get_destination_entity_id()},n))}let se=class extends de{constructor(t){super(t),this.hasError=null,this.error=null,this.editResults=[]}};o([l()],se.prototype,"hasError",void 0),o([l()],se.prototype,"error",void 0),o([l()],se.prototype,"editResults",void 0),se=o([L("esri.rest.knowledgeGraph.GraphApplyEdits")],se);const Vr=se;function Wr(e){const t=new Vr;t.hasError=e.has_error(),t.hasError&&(t.error={errorCode:e.error.error_code,errorMessage:e.error.error_message});const r=e.get_edit_results_count();for(let n=0;n<r;n++){const i=e.get_edit_results_at(n),a=e.get_edit_results_type_name_at(n),s=[],u=[],y=[],d=i.get_add_results_count(),c=i.get_update_results_count(),b=i.get_delete_results_count();for(let T=0;T<d;T++){const h=i.get_add_result_at(T);s.push({id:h.id,error:{errorCode:h.error.error_code,errorMessage:h.error.error_message}})}for(let T=0;T<c;T++){const h=i.get_update_result_at(T);u.push({id:h.id,error:{errorCode:h.error.error_code,errorMessage:h.error.error_message}})}for(let T=0;T<b;T++){const h=i.get_delete_result_at(T);y.push({id:h.id,error:{errorCode:h.error.error_code,errorMessage:h.error.error_message}})}t.editResults.push({typeName:a,adds:s,updates:u,deletes:y})}return t}const ge={fetchKnowledgeGraph:async e=>{const t=new _r({url:e}),r=[];return r.push(Se(t)),r.push(Zr(t)),await Promise.all(r),t},refreshDataModel:async e=>{e.dataModel=await er(e)},refreshServiceDefinition:async e=>{const t=(await ye(e.url,{query:{f:"json"}})).data;return t.capabilities=t?.capabilities?.split(","),t.supportedQueryFormats=t?.supportedQueryFormats?.split(","),e.serviceDefinition=new qt(t),e.serviceDefinition},executeQueryStreaming:async(e,t,r)=>{const n=`${e.url}/graph/query`;await Ae(e);const i=await ze(n,r);i.data.body=await tn(t,e);const a=await Fe(i.data.url,i.data);if(e.dataModel)return new Tt({resultRowsStream:await It(a,e.dataModel)});throw new w("knowledge-graph:undefined-data-model","The KnowledgeGraph supplied did not have a data model")},executeApplyEdits:async(e,t,r)=>{if(e.serviceDefinition?.dataEditingNotSupported)throw new w("knowledge-graph:data-editing-not-supported","The Knowledge Graph Service definition indicated that data editing is not supported");const n=`${e.url}/graph/applyEdits`;await Ae(e);const i=await ze(n,r);return i.data.body=await en(t,e),nn(await Fe(i.data.url,i.data))},executeQuery:async(e,t,r)=>{const n=`${e.url}/graph/query`,i=await ye(n,{responseType:"array-buffer",query:{f:"pbf",openCypherQuery:t.openCypherQuery,...r?.query},signal:r?.signal,timeout:r?.timeout}),a=i.getHeader?.("content-type"),s=i.data;if(a?.includes("application/x-protobuf")){const u=new(await B()).GraphQueryDecoder;if(u.deleteLater(),e.dataModel)return new bt({resultRows:Xe(u,s,e.dataModel)});throw new w("knowledge-graph:undefined-data-model","The KnowledgeGraph supplied did not have a data model")}throw new w("knowledge-graph:unexpected-server-response","server returned an unexpected response",{responseType:a,data:i.data})},executeSearch:async(e,t,r)=>{const n=t.typeCategoryFilter,i=`${e.url}/graph/search`,a=await ye(i,{responseType:"array-buffer",query:{f:"pbf",searchQuery:`"${t.searchQuery}"`,typeCategoryFilter:n,...r?.query},signal:r?.signal,timeout:r?.timeout}),s=a.getHeader?.("content-type"),u=a.data;if(s?.includes("application/x-protobuf")){const y=new(await B()).GraphQueryDecoder;if(y.deleteLater(),e.dataModel)return new bt({resultRows:Xe(y,u,e.dataModel)});throw new w("knowledge-graph:undefined-data-model","The KnowledgeGraph supplied did not have a data model")}throw new w("knowledge-graph:unexpected-server-response","server returned an unexpected response",{responseType:s,data:a.data})},executeSearchStreaming:async(e,t,r)=>{const n=`${e.url}/graph/search`;await Ae(e);const i=await ze(n,r);i.data.body=await rn(t);const a=await Fe(i.data.url,i.data);if(e.dataModel)return new Tt({resultRowsStream:await It(a,e.dataModel)});throw new w("knowledge-graph:undefined-data-model","The KnowledgeGraph supplied did not have a data model")},_fetchWrapper:async(e,t)=>fetch(e,t)};async function Oe(e,t,r){return ge.executeQueryStreaming(e,t,r)}async function Kr(e){return ge.fetchKnowledgeGraph(e)}async function Se(e){return ge.refreshDataModel(e)}async function Zr(e){return ge.refreshServiceDefinition(e)}async function Fe(e,t){return ge._fetchWrapper(e,t)}async function Ae(e){nr?.findCredential(e.url)||(e.dataModel?await er(e):await Se(e))}function ue(e,t,r){if(e.error_code!==0)throw new w(t,r,{errorCode:e.error_code,errorMessage:e.error_message})}function Xr(e,t,r,n){t==null?r.set_param_key_value(e,""):typeof t!="object"||t instanceof Date?r.set_param_key_value(e,t):t instanceof ot?r.set_param_key_value(e,pt(t,n)):t instanceof Array?r.set_param_key_value(e,Yt(t,n)):r.set_param_key_value(e,Bt(t,n))}async function en(e,t){if(t.dataModel||await Se(t),!t.dataModel)throw new w("knowledge-graph:data-model-undefined","Encoding could not proceed because a data model was not provided and it could not be determined from the service");const r=await B(),n=!!e.options?.cascadeDelete,i=new r.GraphApplyEditsEncoder(r.SpatialReferenceUtil.WGS84(),e.options?.inputQuantizationParameters?Cr(e.options?.inputQuantizationParameters):r.InputQuantizationUtil.WGS84_lossless());i.deleteLater(),i.cascade_delete=n;try{let s;e.entityAdds?.forEach(u=>{s=i.add_entity(we(u,r)),ue(s,"knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits - an entity failed to be added to the encoder")}),e.relationshipAdds?.forEach(u=>{if(!u.originId||!u.destinationId)throw new w("knowledge-graph:relationship-origin-destination-missing","When adding a new relationship, you must provide both an origin and destination id on the appropriate class property");s=i.add_relationship(we(u,r)),ue(s,"knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits - a relationship failed to be added to the encoder")}),e.entityUpdates?.forEach(u=>{if(!u.id)throw new w("knowledge-graph:entity-id-missing","When updating an entity or relationship, you must specify the id on the class level property");s=i.update_entity(we(u,r)),ue(s,"knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits - an entity failed to be added to the encoder")}),e.relationshipUpdates?.forEach(u=>{if(!u.id)throw new w("knowledge-graph:relationship-id-missing","When updating an entity or relationship, you must specify the id on the class level property");s=i.update_relationship(we(u,r)),ue(s,"knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits - a relationship failed to be added to the encoder")}),e.entityDeletes?.forEach(u=>{if(!u.typeName)throw new w("knowledge-graph:no-type-name","You must indicate the entity/relationship named object type to apply edits - delete");const y=i.make_delete_helper(u.typeName,!0);y.deleteLater(),u.ids?.forEach(d=>{y.delete_by_id(d)})}),e.relationshipDeletes?.forEach(u=>{if(!u.typeName)throw new w("knowledge-graph:no-type-name","You must indicate the entity/relationship named object type to apply edits - delete");const y=i.make_delete_helper(u.typeName,!1);u.ids?.forEach(d=>{y.delete_by_id(d)})}),i.encode()}catch(s){throw new w("knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits failed",{error:s})}const a=i.get_encoding_result();return ue(a.error,"knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits failed"),a.get_byte_buffer()}async function tn(e,t){const r=await B(),n=new r.GraphQueryRequestEncoder;if(n.deleteLater(),n.output_spatial_reference=r.SpatialReferenceUtil.WGS84(),n.open_cypher_query=e.openCypherQuery,e.bindParameters)for(const[a,s]of Object.entries(e.bindParameters))Xr(a,s,n,r);if(e.bindGeometryQuantizationParameters)Tr(e.bindGeometryQuantizationParameters,n);else{if(t.dataModel||await Se(t),t.dataModel?.spatialReference?.wkid!==4326)throw new w("knowledge-graph:SR-quantization-mismatch","If the DataModel indicates a coordinate system other than WGS84, inputQuantizationParameters must be provided to the query encoder");n.input_quantization_parameters=r.InputQuantizationUtil.WGS84_lossless()}e.outputQuantizationParameters&&Er(e.outputQuantizationParameters,n,r);try{n.encode()}catch(a){throw new w("knowledge-graph:query-encoding-failed","Attempting to encode the query failed",{error:a})}const i=n.get_encoding_result();if(i.error.error_code!==0)throw new w("knowledge-graph:query-encoding-failed","Attempting to encode the query failed",{errorCode:i.error.error_code,errorMessage:i.error.error_message});return i.get_byte_buffer()}async function rn(e){const t=await B(),r=new t.GraphSearchRequestEncoder;if(r.deleteLater(),r.search_query=e.searchQuery,r.type_category_filter=t.esriNamedTypeCategory[e.typeCategoryFilter],e.returnSearchContext===!0&&(r.return_search_context=e.returnSearchContext),e.start!=null&&e.start>0&&(r.start_index=e.start),e.num!=null&&(r.max_num_results=e.num),e.idsFilter!=null&&Array.isArray(e.idsFilter)&&e.idsFilter.length>0)try{r.set_ids_filter(Yt(e.idsFilter,t))}catch(i){throw new w("knowledge-graph:ids-format-error","Attempting to set ids filter failed.  This is usually caused by an incorrectly formatted UUID string",{error:i})}e.namedTypesFilter?.forEach(i=>{r.add_named_type_filter(i)});try{r.encode()}catch(i){throw new w("knowledge-graph:search-encoding-failed","Attempting to encode the search failed",{error:i})}const n=r.get_encoding_result();if(n.error.error_code!==0)throw new w("knowledge-graph:search-encoding-failed","Attempting to encode the search failed",{errorCode:n.error.error_code,errorMessage:n.error.error_message});return n.get_byte_buffer()}async function ze(e,t){return ye(e,{responseType:"native-request-init",method:"post",query:{f:"pbf",...t?.query},body:"x",headers:{"Content-Type":"application/octet-stream"},signal:t?.signal,timeout:t?.timeout})}async function nn(e){const t=e.headers.get("content-type");if(t?.includes("application/x-protobuf")){const r=await e.arrayBuffer(),n=new(await B()).GraphApplyEditsDecoder;return n.deleteLater(),n.decode(new Uint8Array(r)),Wr(n)}throw new w("knowledge-graph:unexpected-server-response","server returned an unexpected response",{responseType:t,data:e.text()})}function Xe(e,t,r){e.push_buffer(new Uint8Array(t));const n=[];let i=0;for(;e.next_row();){i||(i=e.get_header_keys().size());const a=new Array(i);for(let s=0;s<i;s++){const u=e.get_value(s);a[s]=ct(u,r)}n.push(a)}if(e.has_error())throw new w("knowledge-graph:stream-decoding-error","One or more result rows were not successfully decoded",{errorCode:e.error.error_code,errorMessage:e.error.error_message});return n}async function It(e,t){const r=e.headers.get("content-type");if(e.headers.get("content-length")&&pe.getLogger("esri.rest.knowledgeGraph.knowledgeGraphService").warnOnce("Found `Content-Length` header when expecting a streaming HTTP response! Please investigate whether all intermediate HTTP proxies and/or load balancers are configured such that they don't forcefully buffer the entire response before returning it to the client. A valid HTTP streaming response should use Chunked Transfer Encoding and not have a Content Length defined."),r?.includes("application/x-protobuf")){const n=e.body?.getReader(),i=new(await B()).GraphQueryDecoder;return i.deleteLater(),new ReadableStream({async start(a){try{return s()}catch(u){n?.releaseLock(),a.error(new w("knowledge-graph:stream-decoding-error","The server returned a valid response, but there was an error decoding the response stream",{error:u})),a.close()}function s(){return n?.read().then(({done:u,value:y})=>{if(u){let c;if(i.has_error()&&(c=new w("knowledge-graph:stream-decoding-error","One or more result rows were not successfully decoded",{errorCode:i.error.error_code,errorMessage:i.error.error_message})),n.releaseLock(),c)throw a.error(c),c;return void a.close()}const d=Xe(i,y,t);return d.length>0&&a.enqueue(d),s()})}}})}throw new w("knowledge-graph:unexpected-server-response","server returned an unexpected response",{responseType:r,data:e.text()})}async function er(e){const t=`${e.url}/dataModel/queryDataModel`,r=await ye(t,{responseType:"array-buffer",query:{f:"pbf"}}),n=r.getHeader?.("content-type"),i=r.data;if(n?.includes("application/x-protobuf")){const a=(await B()).decode_data_model_from_protocol_buffer(new Uint8Array(i));if(!a)throw new w("knowledge-graph:data-model-decode-failure","The server responded to the data model query, but the response failed to be decoded.  This typically occurs when the Knowledge JS API (4.26 or later) is used with an unsupported backend (11.0 or earlier)");return vr(a)}throw new w("knowledge-graph:unexpected-server-response","server returned an unexpected response",{responseType:n,data:r.data})}let Le=class extends de{constructor(t){super(t),this.openCypherQuery=""}};o([l()],Le.prototype,"openCypherQuery",void 0),Le=o([L("esri.rest.knowledgeGraph.GraphQuery")],Le);const an=Le;let le=class extends an{constructor(t){super(t),this.bindParameters=null,this.bindGeometryQuantizationParameters=null,this.outputQuantizationParameters=null}};o([l()],le.prototype,"bindParameters",void 0),o([l()],le.prototype,"bindGeometryQuantizationParameters",void 0),o([l()],le.prototype,"outputQuantizationParameters",void 0),le=o([L("esri.rest.knowledgeGraph.GraphQueryStreaming")],le);const be=le,I="ESRI__ID",he="ESRI__ORIGIN_ID",Qe="ESRI__DESTINATION_ID",x="ESRI__LAYOUT_GEOMETRY",ee=12,Ct=pe.getLogger("esri.rest.knowledgeGraph.knowledgeGraphLayer.KnowledgeGraphLayerDataManager");let q=class extends de{constructor(t){super(t),this.inclusionModeDefinition={generateAllSublayers:!0,namedTypeDefinitions:new Map},this.entityTypeNames=new Set,this.relationshipTypeNames=new Set,this.geographicLookup=new Map,this.sublayerCaches=new Map,this._processingCacheUpdatesLookup=new Map,this._memberIdTypeLookup=new Map;const r=new Map;t.knowledgeGraph.dataModel.entityTypes?.forEach(n=>{n.name&&(r.set(n.name,"entity"),this._processingCacheUpdatesLookup.set(n.name,[]),t.inclusionModeDefinition&&!t.inclusionModeDefinition?.generateAllSublayers||this.entityTypeNames.add(n.name),n.properties?.forEach(i=>{i.geometryType&&i.geometryType!=="esriGeometryNull"&&this.geographicLookup.set(n.name,{name:i.name??"",geometryType:i.geometryType})}))}),t.knowledgeGraph.dataModel.relationshipTypes?.forEach(n=>{n.name&&(r.set(n.name,"relationship"),this._processingCacheUpdatesLookup.set(n.name,[]),t.inclusionModeDefinition&&!t.inclusionModeDefinition?.generateAllSublayers||this.relationshipTypeNames.add(n.name),n.properties?.forEach(i=>{i.geometryType&&i.geometryType!=="esriGeometryNull"&&this.geographicLookup.set(n.name,{name:i.name??"",geometryType:i.geometryType})}))}),t.inclusionModeDefinition?.namedTypeDefinitions.forEach((n,i)=>{if(r.get(i)==="entity")this.entityTypeNames.add(i);else{if(r.get(i)!=="relationship")return Ct.warn(`A named type, ${i}, was in the inclusion list that wasn't in the data model and will be removed`),void t.inclusionModeDefinition?.namedTypeDefinitions.delete(i);this.relationshipTypeNames.add(i)}const a=new Map;n.members?.forEach(s=>{this._memberIdTypeLookup.set(s.id,i);const u=this.getById(s.id);u&&a.set(s.id,u)}),this.sublayerCaches.set(i,a)})}addToLayerInclusionSet(t){t.forEach(({typeName:r,id:n})=>{if(!this.inclusionModeDefinition)throw new w("knowledge-graph:layer-data-manager","You cannot add to a layer's exclusion list if it was not created with an exclusion list originally");if(this.inclusionModeDefinition.namedTypeDefinitions.has(r)){if(this.inclusionModeDefinition.namedTypeDefinitions.has(r)){const i=this.inclusionModeDefinition.namedTypeDefinitions.get(r);if(i.useAllData)throw new w("knowledge-graph:layer-data-manager","You cannot add members to an exclusion list for a sublayer where the sublayer is set to always retrieve its entire data set");i.members||(i.members=new Map),i.members.set(n,{id:n}),this._memberIdTypeLookup.set(n,r)}}else{const i=new Map;i.set(n,{id:n}),this.inclusionModeDefinition.namedTypeDefinitions.set(r,{useAllData:!1,members:i}),this._memberIdTypeLookup.set(n,r)}})}getById(t){return Pe.getInstance().readFromStoreById(t)}async getData(t,r,n){if(r.objectType.name&&this.inclusionModeDefinition?.namedTypeDefinitions&&this.inclusionModeDefinition.namedTypeDefinitions.size>0&&!this.inclusionModeDefinition.namedTypeDefinitions.has(r.objectType.name))return[];let i;if(i=t||new ie({where:"1=1",outFields:["*"]}),r.parentCompositeLayer.type==="link-chart"){const a=r.parentCompositeLayer,s=this._processingCacheUpdatesLookup.get(r.objectType.name??""),u=i.outFields,y=i.geometry;let d="",c="";y&&y.extent&&(d=Z(y.extent.ymin,y.extent.xmin,ee),c=Z(y.extent.ymax,y.extent.xmax,ee)),u&&u.length===1&&u[0]===I&&i.where==="1=1"||await Promise.all(s??[]);const b=this.sublayerCaches.has(r.objectType.name??"")?Array.from(this.sublayerCaches.get(r.objectType.name)?.values()):[],T=[];return b.forEach(h=>{if(h.geometry=a.linkChartDiagramLookup.get(h.attributes[r.objectIdField]),h.attributes[x]=h.geometry,d&&c){const C=a.linkChartGeohashLookup.get(h.attributes[r.objectIdField]);C?C>=d&&C<=c&&T.push(h):T.push(h)}else T.push(h)}),T}return this.retrieveDataFromService(i,r,n)}async getConnectedRecordIds(t){const r=[],n=[],i=new Map;return t.forEach(a=>{if(this._memberIdTypeLookup.has(a)){const s=this._memberIdTypeLookup.get(a);if(!this.entityTypeNames.has(s))return;i.has(s)?i.get(s)?.push(a):i.set(s,[a])}}),i.forEach((a,s)=>{const u=`MATCH (n:${s})-[r]-(m) WHERE id(n) IN $ids RETURN id(r), type(r), id(m), labels(m)[0]`,y=new Promise(d=>{(async()=>{const c=(await Oe(this.knowledgeGraph,new be({openCypherQuery:u,bindParameters:{ids:a}}))).resultRowsStream.getReader();try{for(;;){const{done:b,value:T}=await c.read();if(b)break;for(let h=0;h<T.length;h++){const C=T[h];r.push({id:C[0],typeName:C[1]}),r.push({id:C[2],typeName:C[3]})}}}catch(b){if(b.name!=="AbortError")throw b;Ct.info("Request aborted as expected")}})().then(()=>{d()})});n.push(y)}),await Promise.all(n),r}async refreshCacheContent(t,r,n,i=!0){const a=Pe.getInstance(),s=[],u=new Map,y=new Map;this.knowledgeGraph.dataModel.entityTypes?.forEach(d=>{d.name&&y.set(d.name,d)}),this.knowledgeGraph.dataModel.relationshipTypes?.forEach(d=>{d.name&&y.set(d.name,d)}),t||this.inclusionModeDefinition?t?t.forEach(d=>{if(this._memberIdTypeLookup.has(d)){const c=this._memberIdTypeLookup.get(d);u.has(c)?u.get(c)?.push(d):u.set(c,[d])}}):this.inclusionModeDefinition?.namedTypeDefinitions?.forEach((d,c)=>{d.useAllData?u.set(c,null):d.members&&d.members.forEach(b=>{u.has(c)&&u.get(c)!==null?u.get(c)?.push(b.id):u.set(c,[b.id])})}):(this.knowledgeGraph.dataModel.entityTypes?.forEach(d=>{d.name&&u.set(d.name,null)}),this.knowledgeGraph.dataModel.entityTypes?.forEach(d=>{d.name&&u.set(d.name,null)}));for(const[d,c]of u){const b=new Promise(T=>{(async()=>{const C=new Set,E=[];let g,_="",M=!1;if(r||y.get(d)?.properties?.forEach(m=>{m.name&&C.add(m.name)}),n&&this.geographicLookup.has(d)){const m=this.geographicLookup.get(d)?.name;m&&C.add(m)}if(this.entityTypeNames.has(d))_=`MATCH (n:${d}) ${c?"WHERE id(n) IN $ids ":""}return ID(n)`,C.forEach(m=>{_+=`, n.${m}`,E.push(m)});else{if(!this.relationshipTypeNames.has(d))throw new w("knowledge-graph:layer-data-manager",`The graph type of ${d} could not be determined. Was this type set in the KG data model and inclusion definition?`);M=!0,_=`MATCH ()-[n:${d}]->() ${c?"WHERE id(n) IN $ids ":""}return ID(n), id(startNode(n)), id(endNode(n))`,C.forEach(m=>{_+=`, n.${m}`,E.push(m)})}g=new be(c?{openCypherQuery:_,bindParameters:{ids:c}}:{openCypherQuery:_});const S=(await Oe(this.knowledgeGraph,g)).resultRowsStream.getReader();for(;;){const{done:m,value:G}=await S.read();if(m)break;const R=[];for(let f=0;f<G.length;f++){const O=G[f];let P=0,Q=0;const J={properties:{}};for(J.id=O[P],P++,Q++,M&&(J.originId=O[P],P++,Q++,J.destinationId=O[P],P++,Q++);P<O.length;P++)J.properties[E[P-Q]]=O[P];R.push(J)}const p=a.writeToStore(R,I,this.geographicLookup.get(d)?.name);this.sublayerCaches.has(d)||this.sublayerCaches.set(d,new Map),i&&!this.inclusionModeDefinition?.namedTypeDefinitions.has(d)&&this.inclusionModeDefinition?.namedTypeDefinitions.set(d,{useAllData:!1,members:new Map}),i&&!this.inclusionModeDefinition?.namedTypeDefinitions.get(d).members&&(this.inclusionModeDefinition.namedTypeDefinitions.get(d).members=new Map);const k=this.sublayerCaches.get(d);p.forEach(f=>{k?.set(f.attributes[I],f),i&&!this.inclusionModeDefinition?.namedTypeDefinitions.get(d).members.has(f.attributes[I])&&(this.inclusionModeDefinition?.namedTypeDefinitions.get(d).members.set(f.attributes[I],{id:f.attributes[I]}),this._memberIdTypeLookup.set(f.attributes[I],d))})}})().then(()=>{T(null)})});s.push(b),this._processingCacheUpdatesLookup.get(d)?.push(b)}await Promise.all(s)}removeFromLayer(t){const r=new Set;t.forEach(n=>{this._memberIdTypeLookup.get(n)&&r.add(this._memberIdTypeLookup.get(n)),this._memberIdTypeLookup.delete(n),this.inclusionModeDefinition?.namedTypeDefinitions.forEach(i=>{i.members?.has(n)&&i.members.delete(n)})}),r.forEach(n=>{this.sublayerCaches.get(n)?.forEach((i,a)=>{t.includes(a)&&this.sublayerCaches.get(n)?.delete(a)})})}async retrieveDataFromService(t,r,n){const i=Pe.getInstance(),a=new Set,s=[];let u,y="",d=[];const c=r.graphType==="relationship",b=this.inclusionModeDefinition?.namedTypeDefinitions?.get(r.objectType.name)?.useAllData,T=r.parentCompositeLayer.sublayerIdsCache.get(r.objectType.name);let h=!b&&T?Array.from(T).sort():null;if(this.inclusionModeDefinition?.namedTypeDefinitions?.get(r.objectType.name)?.useAllData)this.inclusionModeDefinition?.namedTypeDefinitions?.get(r.objectType.name)?.useAllData&&t.objectIds!=null&&(h=t.objectIds);else if(t.objectIds!=null&&h&&h.length>0){const E=t.objectIds;t.objectIds=h.filter(g=>E.includes(g))}else if(t.objectIds!=null)h=t.objectIds;else{if(this.inclusionModeDefinition?.namedTypeDefinitions.has(r.objectType.name)&&(!this.inclusionModeDefinition.namedTypeDefinitions.get(r.objectType.name)?.members||this.inclusionModeDefinition.namedTypeDefinitions.get(r.objectType.name)?.members?.size<1))return t.objectIds=[],[];t.objectIds=h}if(t.outFields!=null){const E=t.outFields;E.includes("*")?r.fields.forEach(g=>{a.add(g.name)}):E.forEach(g=>{g!==I&&g!==r.geometryFieldName&&a.add(g)})}if(t.geometry!=null){const E=t.geometry;let g;if(E?.extent?.spatialReference&&!E.spatialReference?.isWGS84?(await Nt(E.extent.spatialReference,ve),g=Pt(E.extent,ve)):g=E.extent,t.where!=null&&t.where!=="1=1"){const _=await ft(t.where.toUpperCase(),r.fieldsIndex);r.fields.forEach(M=>{_.fieldNames.includes(M.name)&&a.add(M.name)})}y=c?`Match ()-[n:${r.objectType.name}]->() WHERE esri.graph.ST_Intersects($param_filter_geom, n.${r.geometryFieldName}) return ID(n), id(startNode(r)), id(endNode(r))`:`Match (n:${r.objectType.name}) WHERE esri.graph.ST_Intersects($param_filter_geom, n.${r.geometryFieldName}) return ID(n)`,r.geometryFieldName&&a.add(r.geometryFieldName),a.forEach(_=>{y+=`, n.${_}`,s.push(_)}),u=new be({openCypherQuery:y,bindParameters:{param_filter_geom:new fe({rings:[[[g.xmin,g.ymin],[g.xmin,g.ymax],[g.xmax,g.ymax],[g.xmax,g.ymin],[g.xmin,g.ymin]]]})}})}else{let E="";if(t.where!=null&&t.where!=="1=1"){const M=await ft(t.where,r.fieldsIndex);r.fields.forEach(p=>{M.fieldNames.includes(p.name)&&a.add(p.name)});const S=["column-reference","string","number","binary-expression"],m=["=","<","<=","<>",">",">=","AND","OR","LIKE"];let G=!1;const R=p=>{if(p.type==="column-reference")return`n.${p.column}`;if(p.type==="string")return`'${p.value}'`;if(p.type==="number")return`${p.value}`;if(p.type==="binary-expression"&&S.includes(p.left.type)&&S.includes(p.right.type)&&m.includes(p.operator))return`${R(p.left)} ${p.operator} ${R(p.right)}`;if(p.type==="binary-expression"&&p.operator==="LIKE"){let k="";if(p.left.type==="function"&&p.left.args.value[0].type==="column-reference")k+=`lower(n.${p.left.args.value[0].column})`;else{if(p.left.type!=="column-reference")return G=!0,"";k+=`lower(n.${p.left.column})`}if(k+=" CONTAINS (",p.right.type!=="string")return G=!0,"";{let f=p.right.value;f.charAt(0)==="%"&&(f=f.slice(1)),f.charAt(f.length-1)==="%"&&(f=f.slice(0,-1)),k+=`'${f.toLowerCase()}')`}return k}return G=!0,""};E=R(M.parseTree),G&&(E="")}let g="";g=c?`Match ()-[n:${r.objectType.name}]->()`:`Match (n:${r.objectType.name})`;let _=!1;h&&(_=!0,g+=" WHERE ID(n) IN $ids"),E&&(g+=_?" AND":" WHERE",g+=` ${E}`),g+=" return ID(n)",c&&(g+=", id(startNode(n)), id(endNode(n))"),t.returnGeometry&&r.geometryFieldName&&a.add(r.geometryFieldName),a.forEach(M=>{g+=`, n.${M}`,s.push(M)}),u=new be(h?{openCypherQuery:g,bindParameters:{ids:h}}:{openCypherQuery:g})}const C=(await Oe(r.parentCompositeLayer.dataManager.knowledgeGraph,u,n)).resultRowsStream.getReader();for(;;){const{done:E,value:g}=await C.read();if(E)break;const _=[];for(let M=0;M<g.length;M++){const S=g[M];let m=0,G=0;const R={properties:{}};for(R.id=S[m],m++,G++,c&&(R.originId=S[m],m++,G++,R.destinationId=S[m],m++,G++);m<S.length;m++)R.properties[s[m-G]]=S[m];_.push(R)}d=d.concat(i.writeToStore(_,I,r.parentCompositeLayer.dataManager.geographicLookup.get(r.objectType.name)?.name))}return d}};o([l()],q.prototype,"knowledgeGraph",void 0),o([l()],q.prototype,"inclusionModeDefinition",void 0),o([l()],q.prototype,"entityTypeNames",void 0),o([l()],q.prototype,"relationshipTypeNames",void 0),o([l()],q.prototype,"geographicLookup",void 0),o([l()],q.prototype,"sublayerCaches",void 0),q=o([L("esri.rest.knowledgeGraph.knowledgeGraphLayer.KnowledgeGraphLayerDataManager")],q);const Lt=ir(),on=e=>{let t=class extends e{constructor(){super(...arguments),this.fields=[],this.fieldsIndex=null}};return o([l(Lt.fields)],t.prototype,"fields",void 0),o([l(Lt.fieldsIndex)],t.prototype,"fieldsIndex",void 0),t=o([L("esri.layers.knowledgeGraphLayer.KnowledgeGraphSublayerBase")],t),t};let v=class extends ar(on(jt(Ot(or(Ft))))){constructor(e){if(super(e),this.capabilities=fr(!1,!1),this.definitionExpression="",this.displayField="",this.elevationInfo=null,this.geometryType=null,this.geometryFieldName=null,this.graphType=null,this.hasM=!1,this.hasZ=!1,this.labelsVisible=null,this.labelingInfo=null,this.objectIdField=I,this.objectType=null,this.parentCompositeLayer=null,this.popupTemplate=null,this.source={openPorts:()=>this.load().then(()=>{const t=new MessageChannel;return new sr(t.port1,{channel:t,client:{queryFeatures:(r,n={})=>{const i=ie.fromJSON(r);return this.queryFeaturesJSON(i,n)}}},()=>null),[t.port2]})},this.type="knowledge-graph-sublayer",e.parentCompositeLayer.type==="link-chart")e.graphType==="relationship"?this.geometryType="polyline":this.geometryType="point",this.geometryFieldName=x;else if(e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name)?.geometryType&&e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name)?.geometryType!=="esriGeometryNull"){const t=e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name);this.geometryFieldName=t?.name??null,this.geometryType=t?.geometryType?re.fromJSON(t.geometryType):null;const r=t?.name,n=r?e.objectType.properties?.[r]:null;n?(this.hasM=n.hasM??!1,this.hasZ=n.hasZ??!1):(this.hasM=!1,this.hasZ=!1)}else this.geometryType=null;e.objectType.properties?.forEach(t=>{let r=null,n=t.fieldType;n==="esriFieldTypeOID"&&(n="esriFieldTypeInteger"),this.fields.push(gt.fromJSON({name:t.name,type:n,alias:t.alias,defaultValue:r,editable:t.editable,nullable:t.nullable}))}),this.fields.push(gt.fromJSON({name:this.objectIdField,type:"esriFieldTypeString",alias:this.objectIdField,editable:!1})),this._set("fields",[...this.fields]),e.parentCompositeLayer.dataManager.knowledgeGraph.dataModel?.spatialReference&&(this.spatialReference=e.parentCompositeLayer.dataManager.knowledgeGraph.dataModel.spatialReference),e.parentCompositeLayer.type==="link-chart"?e.graphType==="relationship"?this.renderer=$e(Ne(re.toJSON("polyline")).renderer):this.renderer=$e(Ne(re.toJSON("point")).renderer):this.renderer=$e(Ne(re.toJSON(this.geometryType)).renderer)}get defaultPopupTemplate(){return this.createPopupTemplate()}set renderer(e){lr(e,this.fieldsIndex),this._set("renderer",e)}createPopupTemplate(e){return pr(this,e)}createQuery(){return new ie({where:"1=1",outFields:["*"]})}getField(e){for(let t=0;t<this.fields.length;t++)if(this.fields[t].name===e)return this.fields[t];throw new Error("Field not found")}getFieldDomain(e,t){return null}async queryFeatures(e,t){const{resolvedQuery:r,queryEngine:n}=await this._setupQueryObjects(e),i=dr.fromJSON(await n.executeQuery(r.toJSON(),t?.signal));return i.features.forEach(a=>{a.sourceLayer=this}),i}async queryFeaturesJSON(e,t){const{resolvedQuery:r,queryEngine:n}=await this._setupQueryObjects(e);return await n.executeQuery(r.toJSON(),t?.signal)}async queryFeatureCount(e,t){const{resolvedQuery:r,queryEngine:n}=await this._setupQueryObjects(e);return n.executeQueryForCount(r.toJSON(),t?.signal)}async queryExtent(e={},t){const r={...e,returnGeometry:!0},{resolvedQuery:n,queryEngine:i}=await this._setupQueryObjects(r),a=await i.executeQueryForExtent(n.toJSON(),t?.signal);let s;return s=a.extent?.xmin!=null&&a.extent?.xmax!=null&&a.extent?.ymin!=null&&a.extent?.ymax!=null?new De(a.extent):new De,{count:a.count,extent:s}}async queryObjectIds(e,t){const r=ie.from(e);let n;if(this.parentCompositeLayer.type==="link-chart"&&this._cachedQueryEngine)n=this._cachedQueryEngine;else{const i=await this.parentCompositeLayer.dataManager.getData(r,this,t);n=this.loadQueryEngine(i)}return n.executeQueryForIds(r.toJSON(),t?.signal)}loadQueryEngine(e){const t=new yr({geometryType:re.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ}),r=new mr({fields:this.fields.map(n=>n.toJSON()),geometryType:re.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ,objectIdField:this.objectIdField,spatialReference:this.spatialReference.toJSON(),timeInfo:null,featureStore:t});return r.featureStore.addMany(e),r}async refreshCachedQueryEngine(){const e=await this.parentCompositeLayer.dataManager.getData(new ie({where:"1=1",outFields:[I]}),this);this._cachedQueryEngine=this.loadQueryEngine(e)}async _setupQueryObjects(e,t){const r=ie.from(e),n=r.geometry;let i;if(n&&!n.spatialReference?.isWGS84&&(await Nt(n.spatialReference,ve),r.geometry=Pt(n instanceof fe||n instanceof te?n:n.extent,ve)),this.parentCompositeLayer.type==="link-chart"&&this._cachedQueryEngine)i=this._cachedQueryEngine;else{const a=await this.parentCompositeLayer.dataManager.getData(r,this,t);i=this.loadQueryEngine(a)}return{resolvedQuery:r,queryEngine:i}}};o([l()],v.prototype,"capabilities",void 0),o([l({readOnly:!0})],v.prototype,"defaultPopupTemplate",null),o([l()],v.prototype,"definitionExpression",void 0),o([l()],v.prototype,"displayField",void 0),o([l()],v.prototype,"elevationInfo",void 0),o([l()],v.prototype,"geometryType",void 0),o([l()],v.prototype,"geometryFieldName",void 0),o([l()],v.prototype,"graphType",void 0),o([l()],v.prototype,"hasM",void 0),o([l()],v.prototype,"hasZ",void 0),o([l()],v.prototype,"labelsVisible",void 0),o([l()],v.prototype,"labelingInfo",void 0),o([l()],v.prototype,"objectIdField",void 0),o([l()],v.prototype,"objectType",void 0),o([l()],v.prototype,"parentCompositeLayer",void 0),o([l({type:ur,json:{name:"popupInfo",write:!0}})],v.prototype,"popupTemplate",void 0),o([l({types:hr,json:{write:{target:"layerDefinition.drawingInfo.renderer"}}})],v.prototype,"renderer",null),o([l()],v.prototype,"source",void 0),o([l({json:{read:!1}})],v.prototype,"type",void 0),v=o([L("esri.layers.knowledgeGraph.KnowledgeGraphSublayer")],v);const Ue=v;let qe,j=null;function sn(){return qe||(qe=Ye(()=>import("./lclayout-1537ebc4.js"),["./lclayout-1537ebc4.js","./index-f3c752ba.js","./index-a616bda8.css"],import.meta.url).then(e=>e.l).then(({default:e})=>e({locateFile:t=>Be(`esri/libs/linkchartlayout/${t}`)})).then(e=>{ln(e)}),qe)}function ln(e){j=e}var z;function ne(e,t,r,n,i,a){const s=r.length,u=i.length,y=Float64Array.BYTES_PER_ELEMENT,d=Uint32Array.BYTES_PER_ELEMENT,c=Uint8Array.BYTES_PER_ELEMENT,b=16,T=b-1+s*(c+2*y)+u*(2*d),h=j._malloc(T);try{const C=h+b-h%b,E=C+s*y,g=E+s*y,_=g+u*d,M=_+u*d,S=()=>[j.HEAPF64.subarray(C>>3,(C>>3)+s),j.HEAPF64.subarray(E>>3,(E>>3)+s),j.HEAPU32.subarray(g>>2,(g>>2)+u),j.HEAPU32.subarray(_>>2,(_>>2)+u),j.HEAPU8.subarray(M,M+s)],[m,G,R,p,k]=S();m.set(r),G.set(n),R.set(i),p.set(a),k.set(t);const f=e(s,M,C,E,u,g,_),[O,P,Q,J,tr]=S();return r.set(O),n.set(P),i.set(Q),a.set(J),t.set(tr),f}finally{j._free(h)}}(function(e){e[e.None=0]="None",e[e.IsMovable=1]="IsMovable",e[e.IsGeographic=2]="IsGeographic",e[e.IsRoot=4]="IsRoot"})(z||(z={}));const vt=2,Dt=1,xt=-1;var et,tt,rt,nt,it,at,Gt,Rt;(function(e){function t(){return j.getMinIdealEdgeLength()}function r(n,i,a,s,u,y=vt,d=Dt,c=xt){return ne((b,T,h,C,E,g,_)=>j.applyForceDirectedLayout(b,T,h,C,E,g,_,y,d,c),n,i,a,s,u)}e.getMinIdealEdgeLength=t,e.apply=r})(et||(et={})),function(e){function t(r,n,i,a,s,u=vt,y=Dt,d=xt){return ne((c,b,T,h,C,E,g)=>j.applyCommunityLayout(c,b,T,h,C,E,g,u,y,d),r,n,i,a,s)}e.apply=t}(tt||(tt={})),function(e){function t(r,n,i,a,s){return ne(j.applySimpleLayout,r,n,i,a,s)}e.apply=t}(rt||(rt={})),function(e){function t(r,n,i,a,s){return ne(j.applyHierarchicalLayout,r,n,i,a,s)}e.apply=t}(nt||(nt={})),function(e){function t(r,n,i,a,s){return ne(j.applyRadialTreeLayout,r,n,i,a,s)}e.apply=t}(it||(it={})),function(e){function t(r,n,i,a,s){return ne(j.applySmartTreeLayout,r,n,i,a,s)}e.apply=t}(at||(at={})),function(e){e[e.Undirected=0]="Undirected",e[e.Directed=1]="Directed",e[e.Reversed=2]="Reversed"}(Gt||(Gt={})),function(e){e[e.ByCC_Raw=0]="ByCC_Raw",e[e.ByCC_NormalizeGlobally=1]="ByCC_NormalizeGlobally",e[e.ByCC_NormalizeByCC=2]="ByCC_NormalizeByCC"}(Rt||(Rt={}));const pn=(e,t,r)=>(e.has(t)||e.set(t,r()),e.get(t));let N=class extends jt(Ot(Ft)){constructor(e){if(super(e),this.dataPreloadedInLocalCache=!1,this._currentLinkChartConfig={layoutMode:"RADIAL_TREE",xScaleFactor:1,yScaleFactor:1},this._graphTypeLookup=new Map,this.layers=new wt,this.linkChartDiagramLookup=new Map,this.linkChartExtent=new De({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7}),this.linkChartGeohashLookup=new Map,this.sublayerIdsCache=new Map,this.tables=new wt,this.type="link-chart",this._originalInclusionList=e.inclusionModeDefinition,e.dataPreloadedInLocalCache&&!e.inclusionModeDefinition)throw new w("knowledge-graph:linkchart-layer-constructor","If creating a link chart composite layer and configured that data is already loaded in the cache, you must specify an inclusion list so the Composite Layer knows what records belong to it")}normalizeCtorArgs(e){return{url:e.url,title:e.title,dataPreloadedInLocalCache:e.dataPreloadedInLocalCache,defaultLinkChartConfig:e.defaultLinkChartConfig}}_initializeLayerProperties(e){if(!this.title&&this.url){const a=this.url.split("/");this.title=a[a.length-2]}const t=new Set;let r=[],n=[];if(e.inclusionModeDefinition&&(!e.inclusionModeDefinition.namedTypeDefinitions||e.inclusionModeDefinition.namedTypeDefinitions.size<1))throw new w("knowledge-graph:composite-layer-constructor","If an explicit inclusion definition is defined, at least one namedTypeDefinition must also be defined");e.knowledgeGraph.dataModel.entityTypes?.forEach(a=>{a.name&&this._graphTypeLookup.set(a.name,a)}),e.knowledgeGraph.dataModel.relationshipTypes?.forEach(a=>{a.name&&this._graphTypeLookup.set(a.name,a)}),e.inclusionModeDefinition?.generateAllSublayers?(r=e.knowledgeGraph.dataModel.entityTypes??[],n=e.knowledgeGraph.dataModel.relationshipTypes??[]):e.inclusionModeDefinition?.namedTypeDefinitions&&e.inclusionModeDefinition?.namedTypeDefinitions.size>0?e.inclusionModeDefinition?.namedTypeDefinitions.forEach((a,s)=>{if(!this._graphTypeLookup.get(s))return pe.getLogger(this).warn(`A named type, ${s}, was in the inclusion list that wasn't in the data model and will be removed`),void e.inclusionModeDefinition?.namedTypeDefinitions.delete(s);this._graphTypeLookup.get(s)instanceof lt||"strictOrigin"in this._graphTypeLookup.get(s)?t.has(s)||(t.add(s),n.push(this._graphTypeLookup.get(s))):this._graphTypeLookup.get(s)instanceof st||"properties"in this._graphTypeLookup.get(s)?t.has(s)||(t.add(s),r.push(this._graphTypeLookup.get(s))):(pe.getLogger(this).warn(`A named type, ${s}, was in the inclusion list that wasn't properly modeled and will be removed`),e.inclusionModeDefinition?.namedTypeDefinitions.delete(s))}):(r=e.knowledgeGraph.dataModel.entityTypes??[],n=e.knowledgeGraph.dataModel.relationshipTypes??[]);const i=new q({knowledgeGraph:e.knowledgeGraph,inclusionModeDefinition:e.inclusionModeDefinition});this.knowledgeGraph=e.knowledgeGraph,this.memberEntityTypes=r,this.memberRelationshipTypes=n,this.dataManager=i}load(e){return this.addResolvingPromise(new Promise(t=>{Kr(this.url).then(r=>{if(this._initializeLayerProperties({knowledgeGraph:r,inclusionModeDefinition:this._originalInclusionList}),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.size||(this.dataManager.inclusionModeDefinition={generateAllSublayers:!1,namedTypeDefinitions:new Map},this.dataManager.knowledgeGraph.dataModel.entityTypes?.forEach(n=>{n.name&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.set(n.name,{useAllData:!0})}),this.dataManager.knowledgeGraph.dataModel.relationshipTypes?.forEach(n=>{n.name&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.set(n.name,{useAllData:!0})})),this.dataPreloadedInLocalCache)this.loadLayerAssumingLocalCache(),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach(n=>{n.useAllData=!1,n.members?.forEach(i=>{let a;a=i.linkChartLocation instanceof _t?i.linkChartLocation:i.linkChartLocation?V(i.linkChartLocation):null,this.linkChartDiagramLookup.set(i.id,a),a&&a.coords.length===2&&a.lengths.length===0?this.linkChartGeohashLookup.set(i.id,Z(a.coords[1],a.coords[0],ee)):this.linkChartGeohashLookup.set(i.id,"")}),this.addResolvingPromise(this._initializeDiagram().then(async()=>{this.layers.forEach(async i=>{await i.refreshCachedQueryEngine()}),this.tables.forEach(async i=>{await i.refreshCachedQueryEngine()})}))});else{const n=this.defaultLinkChartConfig?.layoutMode==="GEOGRAPHIC";this.addResolvingPromise(this.dataManager.refreshCacheContent(void 0,!1,n,!0).then(async()=>{cr(e);const i=[],a=[];this.loadLayerAssumingLocalCache(),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1,this.dataManager.inclusionModeDefinition.namedTypeDefinitions.forEach(s=>{s.useAllData=!1})),await this._initializeDiagram(),this.layers.forEach(s=>{a.push(s.refreshCachedQueryEngine()),i.push(new Promise(u=>{s.on("layerview-create",()=>{u(null)})}))}),this.tables.forEach(s=>{a.push(s.refreshCachedQueryEngine())}),await Promise.all(a)}))}t(null)})})),Promise.resolve(this)}async addRecords(e){await this._handleNewRecords(e)}async expand(e){const t=await this.dataManager.getConnectedRecordIds(e),r=t.filter(n=>!this.sublayerIdsCache.get(n.typeName)?.has(n.id));return await this._handleNewRecords(t),{records:r}}loadLayerAssumingLocalCache(){this.memberRelationshipTypes.forEach(e=>{const t=new Ue({objectType:e,parentCompositeLayer:this,graphType:"relationship",title:e.name});t.geometryType?this.layers.push(t):this.tables.push(t),this.dataManager.sublayerCaches.has(e.name)||this.dataManager.sublayerCaches.set(e.name,new Map)}),this.memberEntityTypes.forEach(e=>{const t=new Ue({objectType:e,parentCompositeLayer:this,graphType:"entity",title:e.name});t.geometryType?this.layers.push(t):this.tables.push(t),this.dataManager.sublayerCaches.has(e.name)||this.dataManager.sublayerCaches.set(e.name,new Map)}),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach((e,t)=>{const r=pn(this.sublayerIdsCache,t,()=>new Set);e.members?.forEach(n=>{if(r.add(n.id),n.linkChartLocation)if(n.linkChartLocation instanceof _t)this.linkChartDiagramLookup.set(n.id,n.linkChartLocation),n.linkChartLocation.coords.length===2&&n.linkChartLocation.lengths.length===0?this.linkChartGeohashLookup.set(n.id,Z(n.linkChartLocation.coords[1],n.linkChartLocation.coords[0],ee)):this.linkChartGeohashLookup.set(n.id,"");else{const i=V(n.linkChartLocation);this.linkChartDiagramLookup.set(n.id,n.linkChartLocation?i:null),"x"in n.linkChartLocation&&"y"in n.linkChartLocation?this.linkChartGeohashLookup.set(n.id,Z(n.linkChartLocation.x,n.linkChartLocation.y,ee)):this.linkChartGeohashLookup.set(n.id,"")}})})}async calculateLinkChartLayout(e="RADIAL_TREE",t){const r=[],n=[];this.dataManager.sublayerCaches.forEach((p,k)=>{this.dataManager.entityTypeNames.has(k)?p.forEach(f=>{r.push({typeName:k,feature:f})}):this.dataManager.relationshipTypeNames.has(k)&&p.forEach(f=>{n.push({typeName:k,feature:f})})}),this.linkChartDiagramLookup=new Map;const i=new Map,a=new Map,s=new Map,u=new Map,y=new Uint8Array(r.length),d=new Float64Array(r.length),c=new Float64Array(r.length),b=new Uint32Array(n.length),T=new Uint32Array(n.length),h=[],C="FORCE_DIRECTED",E=t?.xScaleFactor??1,g=t?.yScaleFactor??1,_=new De({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7});let M,S="FORCE_DIRECTED",m=0,G=0;switch(S=e==="GEOGRAPHIC"?C:e,S){case"FORCE_DIRECTED":M=et.apply;break;case"COMMUNITY":M=tt.apply;break;case"HIERARCHICAL":M=nt.apply;break;case"RADIAL_TREE":M=it.apply;break;case"SMART_TREE":M=at.apply;break;default:M=rt.apply}r.forEach(({typeName:p,feature:k})=>{if(t?.lockedNodeLocations?.has(k.attributes[I])){e==="GEOGRAPHIC"&&this.dataManager.geographicLookup.has(p)?y[m]=z.IsGeographic:y[m]=z.None;const f=t.lockedNodeLocations.get(k.attributes[I]);d[m]=f.x,c[m]=f.y}else if(e==="GEOGRAPHIC"&&this.dataManager.geographicLookup.has(p)){y[m]=z.IsGeographic;let f=null;const O=k.attributes[this.dataManager.geographicLookup.get(p).name];switch(this.dataManager.geographicLookup.get(p)?.geometryType){case"esriGeometryPoint":d[m]=O?.x,c[m]=O?.y;break;case"esriGeometryPolygon":f=O?.centroid,f?.x!=null&&f?.y!=null?(d[m]=f.x,c[m]=f.y):y[m]=z.IsMovable;break;case"esriGeometryPolyline":case"esriGeometryMultipoint":f=O?.extent?.center,f?.x!=null&&f?.y!=null?(d[m]=f.x,c[m]=f.y):y[m]=z.IsMovable;break;default:y[m]=z.IsMovable}(d[m]==null||c[m]==null||Number.isNaN(d[m])||Number.isNaN(c[m]))&&(y[m]=z.IsMovable,d[m]=0,c[m]=0)}else y[m]=z.IsMovable,d[m]=0,c[m]=0;u.set(k.attributes[I],m),h[m]={feature:k,typeName:p},m++});let R=!1;if(n.forEach(p=>{const k=u.get(p.feature.attributes[he]),f=u.get(p.feature.attributes[Qe]);k!==void 0&&f!==void 0?(b[G]=k,T[G]=f,G++):(R=!0,this.linkChartDiagramLookup.set(p.feature.attributes[he],null),this.linkChartGeohashLookup.set(p.feature.attributes[he],null))}),R&&pe.getLogger(this).warn("A relationship is a member of this layer that has either origin or destination entity nodes that are not members. The diagram geometry will be set to null"),await sn(),!M(y,d,c,b,T))throw new w("knowledge-graph:layout-failed","Attempting to arrange the records in the specified layout failed");for(let p=0;p<h.length;p++){if(y[p]===z.IsMovable&&(d[p]=d[p]*E,c[p]=c[p]*g),c[p]>84.9999&&(c[p]=84.9999),c[p]<-84.9999&&(c[p]=-84.9999),d[p]>179.9999&&(d[p]=179.9999),d[p]<-179.9999&&(d[p]=-179.9999),h[p].feature.attributes[x]=new me(d[p],c[p]),i.has(h[p].typeName))i.get(h[p].typeName)?.set(h[p].feature.attributes[I],h[p].feature);else{const f=new Map;f.set(h[p].feature.attributes[I],h[p].feature),i.set(h[p].typeName,f)}s.set(h[p].feature.attributes[I],h[p].feature);const k=V(h[p].feature.attributes[x]);this.linkChartDiagramLookup.set(h[p].feature.attributes[I],h[p].feature.attributes[x]?k:null),this.linkChartGeohashLookup.set(h[p].feature.attributes[I],Z(h[p].feature.attributes[x].y,h[p].feature.attributes[x].x,ee)),h[p].feature.attributes[x].x<_.xmin&&(_.xmin=h[p].feature.attributes[x].x),h[p].feature.attributes[x].x>_.xmax&&(_.xmax=h[p].feature.attributes[x].x),h[p].feature.attributes[x].y<_.ymin&&(_.ymin=h[p].feature.attributes[x].y),h[p].feature.attributes[x].y>_.ymax&&(_.ymax=h[p].feature.attributes[x].y)}return this.linkChartExtent.xmin=_.xmin,this.linkChartExtent.xmax=_.xmax,this.linkChartExtent.ymin=_.ymin,this.linkChartExtent.ymax=_.ymax,n.forEach(p=>{const k=h[u.get(p.feature.attributes[he])]?.feature.attributes[x],f=h[u.get(p.feature.attributes[Qe])]?.feature.attributes[x];if(!k||!f)return;const O=new te({paths:[[k.x,k.y],[f.x,f.y]]});if(p.feature.attributes[x]=O,a.has(p.typeName))a.get(p.typeName)?.set(p.feature.attributes[I],p.feature);else{const Q=new Map;Q.set(p.feature.attributes[I],p.feature),a.set(p.typeName,Q)}s.set(p.feature.attributes[I],p.feature);const P=V(p.feature.attributes[x]);this.linkChartDiagramLookup.set(p.feature.attributes[I],p.feature.attributes[x]?P:null),this.linkChartGeohashLookup.set(p.feature.attributes[I],"")}),this._currentLinkChartConfig={layoutMode:e,xScaleFactor:E,yScaleFactor:g},{nodes:i,links:a,idMap:s}}async applyNewLinkChartLayout(e="RADIAL_TREE",t){const r=[];await this.calculateLinkChartLayout(e,t),this.layers.forEach(n=>{r.push(n.refreshCachedQueryEngine())}),await Promise.all(r),this.layers.forEach(n=>{n.emit("refresh",{dataChanged:!0})})}getCurrentNodeLocations(){const e=new Map;return this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach(t=>{t?.members?.forEach(r=>{const n=r.linkChartLocation;let i;const a=r.id;n&&(i="x"in n?{x:n.x,y:n.y}:{x:n.coords[0],y:n.coords[1]},e.set(a,new me({x:i.x,y:i.y})))})}),e}async synchronizeInclusionListWithCache(){return new Promise(e=>{this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach((t,r)=>{if(t.useAllData=!1,t.members&&t.members.size>0){if(!this.dataManager.sublayerCaches.get(r))return;const n=Array.from(this.dataManager.sublayerCaches.get(r).keys());Array.from(t.members.keys()).filter(i=>!n.includes(i)).forEach(i=>{t.members?.delete(i)})}}),e()})}async refreshLinkChartCache(e){await this.dataManager.refreshCacheContent(e);const t=[];this.layers.forEach(r=>{t.push(r.refreshCachedQueryEngine())}),await Promise.all(t),this.layers.forEach(r=>{r.emit("refresh",{dataChanged:!0})})}async _handleNewRecords(e){const t=[];this.dataManager.addToLayerInclusionSet(e);for(const r of e)this.sublayerIdsCache.has(r.typeName)||(this.sublayerIdsCache.set(r.typeName,new Set),t.push(r.typeName)),this.sublayerIdsCache.get(r.typeName).add(r.id);for(const r of t)if(this._graphTypeLookup.has(r)){const n=this._graphTypeLookup.get(r),i="endPoints"in n?"relationship":"entity",a=new Ue({objectType:n,parentCompositeLayer:this,graphType:i,title:r});i==="entity"?this.dataManager.entityTypeNames.add(r):this.dataManager.relationshipTypeNames.add(r),a.geometryType?this.layers.push(a):this.tables.push(a),this.dataManager.sublayerCaches.set(r,new Map)}await this.dataManager.refreshCacheContent(e.map(r=>r.id)),await this.applyNewLinkChartLayout(this._currentLinkChartConfig.layoutMode,{xScaleFactor:this._currentLinkChartConfig.xScaleFactor,yScaleFactor:this._currentLinkChartConfig.xScaleFactor})}async _initializeDiagram(){this.defaultLinkChartConfig?this.defaultLinkChartConfig.doNotRecalculateLayout?(this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach(e=>{e?.members?.forEach(t=>{const r=t.linkChartLocation;let n;const i=t.id;if(!r)return;n="x"in r?{x:r.x,y:r.y}:{x:r.coords[0],y:r.coords[1]};const a=V(n);this.linkChartDiagramLookup.set(i,a),this.linkChartGeohashLookup.set(i,Z(n.x,n.y,ee)),this.linkChartExtent.xmin>n.x&&(this.linkChartExtent.xmin=n.x),this.linkChartExtent.xmax<n.x&&(this.linkChartExtent.xmax=n.x),this.linkChartExtent.ymin>n.y&&(this.linkChartExtent.ymin=n.y),this.linkChartExtent.ymax<n.y&&(this.linkChartExtent.ymax=n.y)})}),this.memberRelationshipTypes.forEach(e=>{e.name&&this.dataManager.sublayerCaches.get(e.name)?.forEach(t=>{const r=this.linkChartDiagramLookup.get(t.attributes[he]),n=this.linkChartDiagramLookup.get(t.attributes[Qe]);if(r&&n){const i=V(new te({paths:[[r.coords[0],r.coords[1]],[n.coords[0],n.coords[1]]]}));this.linkChartDiagramLookup.set(t.attributes[I],i)}else this.linkChartDiagramLookup.set(t.attributes[I],null);this.linkChartGeohashLookup.set(t.attributes[I],"")})})):await this.calculateLinkChartLayout(this.defaultLinkChartConfig.layoutMode,{xScaleFactor:this.defaultLinkChartConfig.xScaleFactor,yScaleFactor:this.defaultLinkChartConfig.yScaleFactor,lockedNodeLocations:this.getCurrentNodeLocations()}):await this.calculateLinkChartLayout("RADIAL_TREE",{lockedNodeLocations:this.getCurrentNodeLocations()})}};o([l()],N.prototype,"dataPreloadedInLocalCache",void 0),o([l()],N.prototype,"defaultLinkChartConfig",void 0),o([l()],N.prototype,"dataManager",void 0),o([l()],N.prototype,"knowledgeGraph",void 0),o([l()],N.prototype,"layers",void 0),o([l()],N.prototype,"linkChartDiagramLookup",void 0),o([l()],N.prototype,"linkChartExtent",void 0),o([l()],N.prototype,"linkChartGeohashLookup",void 0),o([l()],N.prototype,"memberEntityTypes",void 0),o([l()],N.prototype,"memberRelationshipTypes",void 0),o([l()],N.prototype,"sublayerIdsCache",void 0),o([l()],N.prototype,"tables",void 0),o([l({json:{read:!1}})],N.prototype,"type",void 0),N=o([L("esri.layers.LinkChartLayer")],N);const Vn=N;export{Vn as default};
